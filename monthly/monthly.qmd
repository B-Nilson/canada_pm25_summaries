<meta name="viewport" content="width=device-width, initial-scale=1">

```{js onpageload}
$(window).on('load', () => on_page_load("#analysis-of-past-month-of-pm2\\.5-observations"));  
```

```{r setup}

source("R/report-functions.R")
source("R/report-constants.R")

run_future_month = FALSE # If true, will run the next month, not the current month. WONT BE COMPLETE DATA

date_range <- report_dir |> 
  file.path("monthly") |> 
  get_report_start_end(type = "monthly", run_future = run_future_month)

output_date_fmt <- date_range[2] |> format("%Y-%m")

hours_to_summarise <- date_range |> make_hourly_seq()

plot_captions <- date_range |> 
  make_plot_captions(networks = names(monitor_groups))

```

```{r loadData, cache=cache }

# Load data from rds from last run if exists, if not, pull from database and create RDS
rds_copy = file.path(report_dir, "data", format(date_range[1], "%Y_%m.rds"))
if(!file.exists(rds_copy)){
  obs <- date_range |> 
    load_report_data(max_pm25_allowed = max_pm25_allowed)
  saveRDS(obs, rds_copy)
}else{
  obs = readRDS(rds_copy)
}

.tmp = make_summaries(obs, type = "monthly", fcst_zones = fcst_zones)
for (i in seq_along(.tmp)) assign(names(.tmp)[i], .tmp[[i]])

```

```{r getNetworkCoverage}


pop_rds = "../resources/spatial/canada_gridded_pop_census_2016.rds"
# If pop rds doesnt exist 
if(!file.exists(pop_rds)){
  neg_to_zero = \(x) ifelse(x<0,0,x)
  # Load gridded pop. data
  pop_shp = file.path("../resources/spatial/griddedPopulationCanada10km_2016_shp",
                      "griddedPopulationCanada10km_2016.shp")
  pop_gridded = read_sf(pop_shp) |>
    # Choose desired columns (+geometry)
    dplyr::select(total = TOT_POP2A, urban = UR_POP2A, rural = RU_POP2A) |>
    # For some reason total not always urban + rural
    # This combines urban and rural as well as any extra pop in the total column
    dplyr::mutate(total = urban + rural + neg_to_zero(total - urban - rural) ) |>
    # Drop 0 pop cells
    dplyr::filter(total > 0)|>
    st_transform(crs = "WGS84")
  
  # Flag by prov/terr
  pt = readRDS("../resources/spatial/aqmap_selection_zones.rds")[-14] |>
    dplyr::select(prov_terr = name)
  pop_gridded = st_join(pop_gridded, pt, left = TRUE, largest = TRUE)
  
  # Save RDS 
  saveRDS(pop_gridded, pop_rds)
}else{
  # Otherwise, just use the rds
  pop_gridded = readRDS(pop_rds)
}

# Mark cell proximity to PA/FEM
locs = obs_monthly |>
  dplyr::ungroup() |>
  dplyr::select(monitor, lat, lng) |>
  st_as_sf(coords = c("lng", "lat"), crs = "WGS84")
pop_centers = suppressWarnings(pop_gridded |> st_centroid())
pop_gridded_coverage = pop_gridded |>
  dplyr::mutate(
    cellID = 1:n(),
    has_nearby_fem = dplyr::filter(locs, monitor == "FEM") |>
      slice(st_nearest_feature(pop_centers, dplyr::filter(locs, monitor == "FEM"))) |>
      st_distance(x = pop_centers, by_element = TRUE),
    has_nearby_fem = as.numeric(has_nearby_fem) < 25000, 
    has_nearby_pa = dplyr::filter(locs, monitor == "PA") |>
      slice(st_nearest_feature(pop_centers, dplyr::filter(locs, monitor == "PA"))) |>
      st_distance(x = pop_centers, by_element = TRUE),
    has_nearby_pa = as.numeric(has_nearby_pa) < 25000,
    has_nearby_monitor = has_nearby_fem | has_nearby_pa
  )

# Summarise PA / FEM / PA+FEM coverage by prov/terr
pop_coverage = pop_gridded_coverage |>
  # Flag province region
  flag_region() 
pop_coverage = pop_coverage |>
  dplyr::bind_rows(dplyr::mutate(pop_coverage, region = "Canada", prov_terr = "Canada")) |>
  dplyr::mutate(region = factor(region, c("West", "Central", "East", "North", "Canada")),
         prov_terr = factor(prov_terr, c(unlist(prov_pretty), "Canada"), 
                              c(names(prov_pretty), "CAN"))) |>
  data.frame() |> # drop spatial column for time saving
  # Mark cells as having nearby FEM, PA, or both
  # dplyr::group_by(cellID) |>
  # dplyr::mutate(has_nearby_fem = any(has_nearby_monitor[network == "FEM Only"]),
  #        has_nearby_pa = any(has_nearby_monitor[network == "PA Only"])) |>
  # Get pop covered/uncovered in each prov/terr by each network
  dplyr::group_by(region, prov_terr, has_nearby_fem, has_nearby_pa) |>
  dplyr::summarise(dplyr::across(c(total, urban, rural), \(x) sum(x, na.rm = TRUE)), .groups = "drop") |>
  # Better network description
  dplyr::mutate(
    network = dplyr::case_when(
      has_nearby_fem & has_nearby_pa ~ "FEM and PA",
      has_nearby_fem ~ "FEM Only",
      has_nearby_pa ~ "PA Only",
      TRUE ~ "No Monitor"
    ) |> factor(c("FEM Only", "FEM and PA", "PA Only", "No Monitor"))
  ) |>
  dplyr::select(-has_nearby_pa, -has_nearby_fem) |>
  tidyr::pivot_longer(c(total, urban, rural), names_to = "pop_type", values_to = "pop") |>
  # dplyr::group_by(region) |>
  # tidyr::complete(prov_terr, network, pop_type) |>
  dplyr::mutate(pop = ifelse(is.na(pop), 0, pop)) |>
  # Get % coverages
  dplyr::group_by(region, prov_terr, pop_type) |>
  dplyr::mutate(
    total_pop = sum(pop, na.rm = TRUE),
    p_pop = round(pop / total_pop,3)
  )

## FNIC coverage (First Nations and Inuit Communities == FNIC)
community_rds = "../resources/spatial/canada_communities.rds"
fnic_locs = readRDS(community_rds) |>
  dplyr::filter(type == "fnic") |>
  dplyr::select(region, prov_terr, name)

fnic_locs_coverage = fnic_locs |>
  dplyr::mutate(
    cellID = 1:n(),
    has_nearby_fem = dplyr::filter(locs, monitor == "FEM") |>
      slice(st_nearest_feature(fnic_locs, dplyr::filter(locs, monitor == "FEM"))) |>
      st_distance(x = fnic_locs, by_element = TRUE),
    has_nearby_fem = as.numeric(has_nearby_fem) < 25000, 
    has_nearby_pa = dplyr::filter(locs, monitor == "PA") |>
      slice(st_nearest_feature(fnic_locs, dplyr::filter(locs, monitor == "PA"))) |>
      st_distance(x = fnic_locs, by_element = TRUE),
    has_nearby_pa = as.numeric(has_nearby_pa) < 25000,
    has_nearby_monitor = has_nearby_fem | has_nearby_pa
  )

data.table::fwrite(fnic_locs_coverage, "../../outputs/fnic_coverage.csv")

fnic_coverage = fnic_locs_coverage |>
  dplyr::bind_rows(dplyr::mutate(fnic_locs_coverage, region = "Canada", prov_terr = "Canada")) |>
  dplyr::mutate(region = factor(region, c("West", "Central", "East", "North", "Canada")),
         prov_terr = factor(prov_terr, c(unlist(prov_pretty), "Canada"), 
                              c(names(prov_pretty), "CAN"))) |>
  data.frame() |> # drop spatial column for time saving
  # Mark cells as having nearby FEM, PA, or both
  # dplyr::group_by(cellID) |>
  # dplyr::mutate(has_nearby_fem = any(has_nearby_monitor[network == "FEM Only"]),
         # has_nearby_pa = any(has_nearby_monitor[network == "PA Only"])) |>
  # Get fnic covered/uncovered in each prov/terr by each network
  dplyr::group_by(region, prov_terr, has_nearby_fem, has_nearby_pa) |>
  dplyr::summarise(pop = sum(rep(1, n(), na.rm = TRUE)), .groups = "drop") |>
  # Better network description
  dplyr::mutate(
    network = dplyr::case_when(
      has_nearby_fem & has_nearby_pa ~ "FEM and PA",
      has_nearby_fem ~ "FEM Only",
      has_nearby_pa ~ "PA Only",
      TRUE ~ "No Monitor"
    ) |> factor(c("FEM Only", "FEM and PA", "PA Only", "No Monitor"))
  ) |>
  dplyr::select(-has_nearby_pa, -has_nearby_fem) |>
  dplyr::mutate(pop_type = "fnic") |>
  # dplyr::group_by(region) |>
  # tidyr::complete(prov_terr, network, pop_type) |>
  dplyr::mutate(pop = ifelse(is.na(pop), 0, pop)) |>
  # Get % coverages
  dplyr::group_by(region, prov_terr, pop_type) |>
  dplyr::mutate(
    total_pop = sum(pop, na.rm = TRUE),
    p_pop = round(pop / total_pop,3)
  )

coverage = dplyr::bind_rows(pop_coverage, fnic_coverage)

```

```{r handleOldReports}

old_report_dropdown = report_dir |>
  handle_old_reports(report_pattern = "\\d\\.html$",
                     date_range[2], type = "monthly")

```

<center><h4>----- \*BETA PRODUCT\* -----</h4></center>
<center><h1>Canadian PM<sub>2.5</sub> Observations Monthly Summary</h1></center>
<center><h3>Non-validated Data - <mark class="bg-info">`r max(obs$date) |> format("%B %Y")`</mark> Report</h3></center>

`r if(run_future_month) paste0("<center><h4>**WARNING - This report is incomplete. It only contains data up to ",max(obs$date) |> format("%B %d"),"**</h4></center>") |> HTML()`

|  

## Overview {.unlisted .unnumbered}

::: card

::: card-body

This report is a summary of the **fine particulate matter (PM<sub>2.5</sub>)** observation data in Canada for the **past 1 month** from the regulatory **Federal Equivalent Method (FEM)** monitors and the network of low-cost monitors from **PurpleAir (PA)**. It is in beta stage and being actively developed. Significant changes may occur without warning. This report is automatically updated at the end of every month. 

`r old_report_dropdown`

For any concerns, questions, or feedback regarding this report or the data within it, please contact brayden.nilson@ec.gc.ca

<details>

<summary>Click here for more details.</summary>
PM<sub>2.5</sub> is a major constituent of wildfire smoke and has significant health risks associated with acute and chronic exposure. FEM monitors are the gold-standard for real-time data quality for PM<sub>2.5</sub>; however installations are limited by capital and maintenance costs. PA monitors are less accurate than their FEM counterparts, but are much less cost prohibitive allowing large numbers to be installed. FEM monitors provide **great** data, but PA monitors provide **more** (good) data, and are very useful as "smoke detectors" during wildfire smoke events.

All PM<sub>2.5</sub> data are sourced from the [UNBC AQmap](https://aqmap.ca/aqmap) data repository.

- Data from the FEM network originate from [AirNow](https://www.airnow.gov/about-airnow/), and are NOT VALIDATED. No QA/QC is applied after retrieval from AirNow, and official values may differ from those presented here.

- Data from the PA network originate from the [PurpleAir API](https://api.purpleair.com/), and a rigorous automated QA/QC method is applied to ensure the best available data are used. The [UNBC/ECCC bias correction](https://amt.copernicus.org/articles/15/3315/2022/) is applied to all PA data to improve comparability with FEM values.

</details>
:::

:::

<div id="loading" style="text-align:center;display: flex; align-items: center; justify-content: center; height: 250px;">
<div>
  <p>Loading, please wait...</p>
  <p><img id="loading-image" src="./icons/loading.gif" alt="Loading..." /></p>
</div>
</div>

## Analysis of Past Month of PM<sub>2.5</sub> Observations {.tabset .tabset-dropdown style="display: none;"}
*Select your question from the following dropdown menu*

### <big><strong>How many observation sites at each risk level?</strong></big> {.tabset}

```{r prov_donuts}

# Define dimensions for output figures
fig_dims = list(h = 7, w = 11, u = 'in')

# Prov/Terr monitor counts for centers of donuts
labels = obs_summary |>
  dplyr::bind_rows(obs_summary |> dplyr::mutate(monitor = "FEM and PA")) |>
  dplyr::full_join(
    expand.grid(prov_terr = names(prov_pretty), monitor = c("PA","FEM","FEM and PA"))
  ) |>
  dplyr::group_by(prov_terr, monitor) |>
  dplyr::summarise(n = sum(!is.na(pm25_max))) |>
  dplyr::mutate(label = paste("n =\n",n), x = 0, y=0)

pd = list()
plot_paths = list()
for(stat in c("mean", "max")){
  # Get data for donut plots
  pd[[stat]] = make_donut_data(obs_summary, paste0("pm25_", stat))
  
  # Create paths for donut plots
  plot_paths[[stat]] = paste0(report_dir,
    "plots/monitor_", stat, "_donuts_", 
    monitor_groups |> 
      stringr::str_to_lower() |> 
      stringr::str_replace_all(" ", "_"),
    "_", output_date_fmt, ".png"
  ) |> setNames(monitor_groups)
  
  # Make and save donut plots
  .tmp = monitor_groups |>
    setNames(monitor_groups) |>
    lapply(
      \(m){
          pth = plot_paths[[stat]][[m]]
          pd[[stat]] |> 
            make_donut_plot(labels, m |> stringr::str_remove(" Only"), 
                            stringr::str_to_title(stat), format(date_range[2], "%b.")) |> 
            ggsave(filename = pth, dpi = 300, units = fig_dims$u, 
                   height = fig_dims$h, width = fig_dims$w)
      }
    )
}

# Define plot summary text (figure titles essentially)
plot_text = list()
plot_text$mean = 'Distribution of monthly mean concentrations at %m PM<sub>2.5</sub> monitoring sites within each province/territory. The number within each circle indicates the total number of monitors with data in that area. Percents indicate the amount of those monitors with a monthly mean within that concentration range.'
plot_text$max = plot_text$mean |> stringr::str_replace("mean","max")

# Make summary data for autmated text for this section
.tmp = pd$mean |>
  dplyr::select(-1) |>
  subset(monitor!= "FEM and PA") |>
  dplyr::group_by(monitor, aqhi_p) |>
  dplyr::summarise(n = sum(n)) |>
  dplyr::mutate(p = round(n / sum(n) *100,1))

p_fem = subset(.tmp, monitor =="FEM")
p_pa = subset(.tmp, monitor =="PA")

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

There was <strong>`r sum(p_fem$n)` FEM sites</strong> and <strong>`r sum(p_pa$n)` PA sites</strong> reporting PM<sub>2.5</sub> in Canada in `r format(date_range[2], "%B %Y")`. <strong>

- `r  p_fem$p[4]`%</strong> of the FEM sites had a 1-month mean exceeding 100 &mu;g m<sup>-3</sup>, <strong> `r p_fem$p[3]`%</strong> were between 60 and 100 &mu;g m<sup>-3</sup>, and <strong> `r p_fem$p[2]`%</strong> were between 30 and 60 &mu;g m<sup>-3</sup>.<strong> 

- `r p_pa$p[4]`%</strong> of the PA sites in Canada had a 1-month mean exceeding 100 &mu;g m<sup>-3</sup>, <strong> `r p_pa$p[3]`%</strong> were between 60 and 100 &mu;g m<sup>-3</sup>, and <strong> `r p_pa$p[2]`%</strong> were between 30 and 60 &mu;g m<sup>-3</sup>.
  
</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
plot_paths$mean[['FEM and PA']] |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text$mean |> stringr::str_replace("%m","regulatory (FEM) and PurpleAir (PA)"))
```

```{r include=TRUE, results = 'asis'}
plot_paths$max[['FEM and PA']] |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text$max |> stringr::str_replace("%m","regulatory (FEM) and PurpleAir (PA)"))
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
plot_paths$mean[['FEM Only']] |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text$mean |> stringr::str_replace("%m","regulatory (FEM)"))
```

```{r include=TRUE, results = 'asis'}
plot_paths$max[['FEM Only']] |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text$max |> stringr::str_replace("%m","regulatory (FEM)"))
```

#### PA Only

```{r include=TRUE, results = 'asis'}
plot_paths$mean[['PA Only']] |> 
  stringr::str_replace(report_dir_esc,"./") |> 
  plot_card(plot_text$mean |> stringr::str_replace("%m","PurpleAir (PA)"))
```

```{r include=TRUE, results = 'asis'}
plot_paths$max[['PA Only']] |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text$max |> stringr::str_replace("%m","PurpleAir (PA)"))
```

### <big><strong>Who had access to nearby observations?</strong></big> {.tabset}

```{r coverage_charts}
fig_dims = list(h = 7, w = 9, u = 'in')

c_types = c("urban", "rural", "total", "fnic")
coverage_barcharts = lapply(c_types, 
                            \(p) coverage |>
                              dplyr::filter(pop_type == p) |>
                              pop_coverage_barchart(p)) |>
  setNames(c_types)

plot_paths =  paste0(report_dir,
    "plots/coverage_", c_types, 
    "_", output_date_fmt, ".png"
  ) |> 
  as.list() |>
  setNames(c_types)

for(ct in names(plot_paths)){
  ggsave(coverage_barcharts[[ct]],
    filename = plot_paths[[ct]], dpi = 300, 
         units = fig_dims$u, height = fig_dims$h, width = fig_dims$w)
}
plot_text = paste(
  "Estimated percentage of Canadian %c within 25 km of a",
  "regulatory (FEM) and/or low-cost PurpleAir (PA) PM<sub>2.5</sub> monitor",
  "during the month of", format(date_range[2], "%B, %Y."),
  "The patterned section shows overlapping coverage of the two networks (i.e. %c covered by both networks).",
  "Data for %c sourced from %s.")

# Make coverage table
td = coverage |>
  dplyr::select(-total_pop) |>
  dplyr::mutate(p_pop = paste0(p_pop * 100, "%")) |>
  tidyr::pivot_wider(names_from = pop_type, values_from = c(pop, p_pop)) |>
  dplyr::arrange(region, prov_terr, network) |>
  dplyr::mutate(dplyr::across(c(pop_fnic, pop_rural, pop_urban, pop_total), \(p) format(ifelse(is.na(p),0,p), big.mark = ","))) |>
  dplyr::select(Region = region, `Prov./Terr.` = prov_terr, "Within 25km of" = network, 
         pop_fnic, p_pop_fnic, 
         pop_rural, p_pop_rural, 
         pop_urban, p_pop_urban, 
         pop_total, p_pop_total)
coverage_table = reactable(data = td,
                   pagination= FALSE,
            columns = list(
              pop_fnic = colDef("Count"),
              p_pop_fnic = colDef("Percentage"),
              pop_total = colDef("Count"),
              p_pop_total = colDef("Percentage"),
              pop_rural = colDef("Count"),
              p_pop_rural = colDef("Percentage"),
              pop_urban = colDef("Count"),
              p_pop_urban = colDef("Percentage")
            ),
            columnGroups = list(
              colGroup(name = "FN & Inuit Communities", 
                       columns = c("pop_fnic", "p_pop_fnic")),
              colGroup(name = "Total Pop. (2016)", 
                       columns = c("pop_total", "p_pop_total")),
              colGroup(name = "Urban Pop. (2016)", 
                       columns = c("pop_urban", "p_pop_urban")),
              colGroup(name = "Rural Pop. (2016)", 
                       columns = c("pop_rural", "p_pop_rural")))
    )
coverage_dl = td |>
   download_this(
    output_name = "network_coverage_" |> 
      paste0(max(obs$date) |> format("%Y-%B")),
    output_extension = ".csv",sep = ",", dec = ".",
    button_label = "Download data as csv",
    button_type = "default",
    has_icon = TRUE,
    csv2 = FALSE,
    icon = "fa fa-save"
  )

p_summ = td |>
  dplyr::group_by(pt = `Prov./Terr.`)|>
  dplyr::mutate(
    pop_fnic = as.numeric(stringr::str_remove_all(pop_fnic,",")),
    pop_rural = as.numeric(stringr::str_remove_all(pop_rural,",")),
    pop_urban = as.numeric(stringr::str_remove_all(pop_urban,",")),
    pop_total = as.numeric(stringr::str_remove_all(pop_total,",")),
    total_fnic = sum(pop_fnic, na.rm=TRUE),
    total_rural = sum(pop_rural, na.rm=TRUE),
    total_urban = sum(pop_urban, na.rm=TRUE),
    total_total = sum(pop_total, na.rm=TRUE)
  ) |>
  dplyr::filter(`Within 25km of` != "No Monitor") |>
  dplyr::summarise(
    p_fnic = round(sum(pop_fnic / total_fnic, na.rm=TRUE) *100,1),
    p_urban = round(sum(pop_rural / total_rural, na.rm=TRUE) *100,1),
    p_rural = round(sum(pop_urban / total_urban, na.rm=TRUE) *100,1),
    p_total = round(sum(pop_total / total_total, na.rm=TRUE) *100,1))
reg_summ = td |>
  dplyr::group_by(Region) |>
  dplyr::mutate(
    pop_fnic = as.numeric(stringr::str_remove_all(pop_fnic,",")),
    pop_rural = as.numeric(stringr::str_remove_all(pop_rural,",")),
    pop_urban = as.numeric(stringr::str_remove_all(pop_urban,",")),
    pop_total = as.numeric(stringr::str_remove_all(pop_total,",")),
    total_fnic = sum(pop_fnic, na.rm=TRUE),
    total_rural = sum(pop_rural, na.rm=TRUE),
    total_urban = sum(pop_urban, na.rm=TRUE),
    total_total = sum(pop_total, na.rm=TRUE)
  ) |>
  dplyr::filter(`Within 25km of` != "No Monitor") |>
  dplyr::summarise(
    p_fnic = round(sum(pop_fnic / total_fnic, na.rm=TRUE) *100,1),
    p_urban = round(sum(pop_rural / total_rural, na.rm=TRUE) *100,1),
    p_rural = round(sum(pop_urban / total_urban, na.rm=TRUE) *100,1),
    p_total = round(sum(pop_total / total_total, na.rm=TRUE) *100,1))


```


::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

Across Canada, `r dplyr::filter(reg_summ, Region == "Canada")$p_total[1]`% of the population (`r dplyr::filter(reg_summ, Region == "Canada")$p_rural[1]`% of rural and `r dplyr::filter(reg_summ, Region == "Canada")$p_urban[1]`% of urban) and `r dplyr::filter(reg_summ, Region == "Canada")$p_fnic[1]`% of Indigenous communities were within 25 km of a regulatory or low-cost PurpleAir PM<sub>2.5</sub> monitor in `r format(date_range[2], "%B of %Y")`.

In the west, `r dplyr::filter(reg_summ, Region == "West")$p_total[1]`% of the *total population* was within 25 km of a PA or FEM PM<sub>2.5</sub> monitor (`r dplyr::filter(p_summ, pt == "BC")$p_total[1]`% for BC, `r dplyr::filter(p_summ, pt == "AB")$p_total[1]`% for AB, `r dplyr::filter(p_summ, pt == "SK")$p_total[1]`% for SK and `r dplyr::filter(p_summ, pt == "MB")$p_total[1]`% for MB). For the central provinces, `r dplyr::filter(reg_summ, Region == "Central")$p_total[1]`% of the population (`r dplyr::filter(p_summ, pt == "ON")$p_total[1]`% for ON and `r dplyr::filter(p_summ, pt == "QC")$p_total[1]`% for QC) was within 25 km of a PM<sub>2.5</sub> monitor. In the east, `r dplyr::filter(reg_summ, Region == "East")$p_total[1]`% of the population (`r dplyr::filter(p_summ, pt == "NS")$p_total[1]`% for NS, `r dplyr::filter(p_summ, pt == "NB")$p_total[1]`% for NB, `r dplyr::filter(p_summ, pt == "NL")$p_total[1]`% for NL and `r dplyr::filter(p_summ, pt == "PE")$p_total[1]`% for PE) was within 25 km of a PM<sub>2.5</sub> monitor. For the territories, `r dplyr::filter(reg_summ, Region == "North")$p_total[1]`% of the population (`r dplyr::filter(p_summ, pt == "YK")$p_total[1]`% for YT, `r dplyr::filter(p_summ, pt == "NT")$p_total[1]`% for NT and `r dplyr::filter(p_summ, pt == "NU")$p_total[1]`% for NU) was within 25 km of a PM<sub>2.5</sub> monitor.

In the west, `r dplyr::filter(reg_summ, Region == "West")$p_fnic[1]`% of *Indigenous communities* were within 25 km of a PA or FEM PM<sub>2.5</sub> monitor (`r dplyr::filter(p_summ, pt == "BC")$p_fnic[1]`% for BC, `r dplyr::filter(p_summ, pt == "AB")$p_fnic[1]`% for AB, `r dplyr::filter(p_summ, pt == "SK")$p_fnic[1]`% for SK and `r dplyr::filter(p_summ, pt == "MB")$p_fnic[1]`% for MB). For the central provinces, `r dplyr::filter(reg_summ, Region == "Central")$p_fnic[1]`% of Indigenous communities (`r dplyr::filter(p_summ, pt == "ON")$p_fnic[1]`% for ON and `r dplyr::filter(p_summ, pt == "QC")$p_fnic[1]`% for QC) were within 25 km of a PM<sub>2.5</sub> monitor. In the east, `r dplyr::filter(reg_summ, Region == "East")$p_fnic[1]`% of Indigenous communities (`r dplyr::filter(p_summ, pt == "NS")$p_fnic[1]`% for NS, `r dplyr::filter(p_summ, pt == "NB")$p_fnic[1]`% for NB, `r dplyr::filter(p_summ, pt == "NL")$p_fnic[1]`% for NL and `r dplyr::filter(p_summ, pt == "PE")$p_fnic[1]`% for PE) were within 25 km of a PM<sub>2.5</sub> monitor. For the territories, `r dplyr::filter(reg_summ, Region == "North")$p_fnic[1]`% of Indigenous communities (`r dplyr::filter(p_summ, pt == "YK")$p_fnic[1]`% for YT, `r dplyr::filter(p_summ, pt == "NT")$p_fnic[1]`% for NT and `r dplyr::filter(p_summ, pt == "NU")$p_fnic[1]`% for NU) were within 25 km of a PM<sub>2.5</sub> monitor.

In the west, `r dplyr::filter(reg_summ, Region == "West")$p_urban[1]`% of the *urban population* was within 25 km of a PA or FEM PM<sub>2.5</sub> monitor (`r dplyr::filter(p_summ, pt == "BC")$p_urban[1]`% for BC, `r dplyr::filter(p_summ, pt == "AB")$p_urban[1]`% for AB, `r dplyr::filter(p_summ, pt == "SK")$p_urban[1]`% for SK and `r dplyr::filter(p_summ, pt == "MB")$p_urban[1]`% for MB). For the central provinces, `r dplyr::filter(reg_summ, Region == "Central")$p_urban[1]`% of the urban population (`r dplyr::filter(p_summ, pt == "ON")$p_urban[1]`% for ON and `r dplyr::filter(p_summ, pt == "QC")$p_urban[1]`% for QC) was within 25 km of a PM<sub>2.5</sub> monitor. In the east, `r dplyr::filter(reg_summ, Region == "East")$p_urban[1]`% of the urban population (`r dplyr::filter(p_summ, pt == "NS")$p_urban[1]`% for NS, `r dplyr::filter(p_summ, pt == "NB")$p_urban[1]`% for NB, `r dplyr::filter(p_summ, pt == "NL")$p_urban[1]`% for NL and `r dplyr::filter(p_summ, pt == "PE")$p_urban[1]`% for PE) was within 25 km of a PM<sub>2.5</sub> monitor. For the territories, `r dplyr::filter(reg_summ, Region == "North")$p_urban[1]`% of the urban population (`r dplyr::filter(p_summ, pt == "YK")$p_urban[1]`% for YT, `r dplyr::filter(p_summ, pt == "NT")$p_urban[1]`% for NT and `r dplyr::filter(p_summ, pt == "NU")$p_urban[1]`% for NU) was within 25 km of a PM<sub>2.5</sub> monitor.

In the west, `r dplyr::filter(reg_summ, Region == "West")$p_rural[1]`% of the *rural population* was within 25 km of a PA or FEM PM<sub>2.5</sub> monitor (`r dplyr::filter(p_summ, pt == "BC")$p_rural[1]`% for BC, `r dplyr::filter(p_summ, pt == "AB")$p_rural[1]`% for AB, `r dplyr::filter(p_summ, pt == "SK")$p_rural[1]`% for SK and `r dplyr::filter(p_summ, pt == "MB")$p_rural[1]`% for MB). For the central provinces, `r dplyr::filter(reg_summ, Region == "Central")$p_rural[1]`% of the rural population (`r dplyr::filter(p_summ, pt == "ON")$p_rural[1]`% for ON and `r dplyr::filter(p_summ, pt == "QC")$p_rural[1]`% for QC) was within 25 km of a PM<sub>2.5</sub> monitor. In the east, `r dplyr::filter(reg_summ, Region == "East")$p_rural[1]`% of the rural population (`r dplyr::filter(p_summ, pt == "NS")$p_rural[1]`% for NS, `r dplyr::filter(p_summ, pt == "NB")$p_rural[1]`% for NB, `r dplyr::filter(p_summ, pt == "NL")$p_rural[1]`% for NL and `r dplyr::filter(p_summ, pt == "PE")$p_rural[1]`% for PE) was within 25 km of a PM<sub>2.5</sub> monitor. For the territories, `r dplyr::filter(reg_summ, Region == "North")$p_rural[1]`% of the rural population (`r dplyr::filter(p_summ, pt == "YK")$p_rural[1]`% for YT, `r dplyr::filter(p_summ, pt == "NT")$p_rural[1]`% for NT and `r dplyr::filter(p_summ, pt == "NU")$p_rural[1]`% for NU) was within 25 km of a PM<sub>2.5</sub> monitor.
  
</details>

:::
:::

*Select which population subset to view using the following tabs*

#### Total Population

```{r include=TRUE, results = 'asis'}
plot_paths$total |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text |> stringr::str_replace_all("%c","total population") |> 
              stringr::str_replace_all("%s","the gridded 2016 census: https://open.canada.ca/data/en/dataset/c6c48391-fd2f-4d8a-93c8-eb74f58a859b"))
```

#### First Nations and Inuit Communities

```{r include=TRUE, results = 'asis'}
plot_paths$fnic |> 
  stringr::str_replace(report_dir_esc,"./") |>
  plot_card(plot_text |> stringr::str_replace_all("%c","First Nation and Inuit communities") |> 
              stringr::str_replace_all("%s","https://open.canada.ca/data/en/dataset/b6567c5c-8339-4055-99fa-63f92114d9e4 and https://open.canada.ca/data/en/dataset/2bcf34b5-4e9a-431b-9e43-1eace6c873bd"))
```

#### Urban Population

```{r include=TRUE, results = 'asis'}
plot_paths$urban |> 
  stringr::str_replace(report_dir_esc,"./") |> 
  plot_card(plot_text |> stringr::str_replace_all("%c","urban population") |> 
              stringr::str_replace_all("%s","the gridded 2016 census: https://open.canada.ca/data/en/dataset/c6c48391-fd2f-4d8a-93c8-eb74f58a859b"))
```

#### Rural Population

```{r include=TRUE, results = 'asis'}
plot_paths$rural |> 
  stringr::str_replace(report_dir_esc,"./") |> 
  plot_card(plot_text |> stringr::str_replace_all("%c","rural population") |> 
              stringr::str_replace_all("%s","the gridded 2016 census: https://open.canada.ca/data/en/dataset/c6c48391-fd2f-4d8a-93c8-eb74f58a859b"))
```

#### Coverage Table

```{r include = TRUE, cache = FALSE}
coverage_dl
coverage_table
```

### <big><strong>Where and when were PM<sub>2.5</sub> concentrations high?</strong></big>{.tabset}

```{r, maps}

# Daily Zone Summaries ----------------------------------------------------

legend_title = "Daily Mean<br>PM<sub>2.5</sub> (Î¼g m<sup>-3</sup>)"

plot_text = "Interactive map summarizing the daily mean concentrations from both FEM and PA monitors by forecast zone for the month. You can use the control menu in the top right to step through the days in the month. If you hover over a forecast zone a summary popup will appear for that zone for the displayed day."
plot_title = paste0("Animated Map of Daily Forecast Zone Mean PM<sub>2.5</sub> for ",format(date_range[2],"%B %Y"))
plot_path = paste0(report_dir, "plots/fcstzone_mean_map_daily_", 
                    output_date_fmt,".html")


# To add slider controls see jsfiddle.net/qs6dL200
map = make_anim_map(zone_sum_daily, legend_title,
                    height = 600)

mapview::mapshot(map, plot_path,libdir="./libs",selfcontained= FALSE)

# Monthly Zone Summaries ----------------------------------------------------

plot2_text = "Interactive map summarizing the monthly mean concentrations from both FEM and PA monitors by forecast zone. On the left the mean values are presented, and max values are presented on the right. If you hover over a forecast zone a summary popup will appear for that zone."
plot2_title = paste0("Map of Forecast Zone Mean [left] and Max [right] for ",format(date_range[2],"%B %Y"))
plot2_path = paste0(report_dir, "plots/fcstzone_mean_map_", 
                    output_date_fmt,".html")

legend_titles = list()
legend_titles$pm25 = legend_title |>
    stringr::str_replace("Daily", format(date_range[2],"%b."))
legend_titles$pm25_max = legend_titles$pm25 |> 
  stringr::str_replace("Mean", "Max")

map = make_sync_map(zone_sum_month, 
                    cols = c("pm25", "pm25_max"), 
                    legend_titles)


htmltools::save_html(map, plot2_path, libdir="./libs")

# Make summary data for autmated text for this section
aqhi_p_counts_by_prov = obs_summary |>
  dplyr::group_by(aqhi_p_24hr = aqhi_p(pm25_mean, by_risk = TRUE, include_ugm3_range = TRUE),
           prov_terr, monitor) |>
  dplyr::summarise(n_monitors = n(), .groups = "drop") |>
  tidyr::pivot_wider(1:2, names_from = "monitor", values_from = "n_monitors") 
aqhi_p_counts_by_prov = aqhi_p_counts_by_prov |>
  dplyr::full_join(expand.grid(aqhi_p_24hr = levels(aqhi_p_counts_by_prov$aqhi_p_24hr), 
                        prov_terr = names(prov_pretty)), 
            by = c("aqhi_p_24hr", "prov_terr")) |>
  dplyr::mutate(dplyr::across(c("FEM","PA"), \(x) handyr::swap(x, what = NA, with = 0))) |>
  dplyr::arrange(as.numeric(aqhi_p_24hr))

aqhi_p_counts = aqhi_p_counts_by_prov |>
  dplyr::select(-prov_terr) |>
  dplyr::group_by(aqhi_p_24hr) |>
  dplyr::summarise(dplyr::across(dplyr::everything(), sum)) 

very_high_fem_by_prov = aqhi_p_counts_by_prov |> 
  subset(FEM != 0 & aqhi_p_24hr == "Very High [100+]") |>
  dplyr::arrange(desc(FEM))
high_fem_by_prov = aqhi_p_counts_by_prov |> 
  subset(FEM != 0 & aqhi_p_24hr == "High [60-100)") |>
  dplyr::arrange(desc(PA))
very_high_pa_by_prov = aqhi_p_counts_by_prov |> 
  subset(PA != 0 & aqhi_p_24hr == "Very High [100+]") |>
  dplyr::arrange(desc(FEM))
high_pa_by_prov = aqhi_p_counts_by_prov |> 
  subset(PA != 0 & aqhi_p_24hr == "High [60-100)") |>
  dplyr::arrange(desc(PA))

wd = worst_day_df |>
  dplyr::select(p=`Prov./Terr.`,w=`Worst Day`,m=`Mean of Site Means`) |>
  dplyr::arrange(p) |>
  dplyr::group_by(w) |>
  dplyr::summarise(m = join_list_sentence(m) |> 
              paste0(ifelse(length(p)>1,", respectively","")),
            p = join_list_sentence(p) ) |>
  dplyr::mutate(t = paste0("- ",p,": ",w," - 24-hour mean PM<sub>2.5</sub>: ", m," &mu;g m<sup>-3</sup>"))
```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

There was <strong>`r aqhi_p_counts$FEM[4]` FEM monitors</strong> and <strong>`r aqhi_p_counts$PA[4]` PA monitors</strong> in Canada with a mean PM<sub>2.5</sub> concentration for `r format(date_range[2], "%B %Y")` <strong>exceeding 100 &mu;g m<sup>-3</sup></strong>

`r paste0(ifelse(nrow(very_high_fem_by_prov), "* ",""), format_count_summary(very_high_fem_by_prov,"FEM","exceeding 100"))`

`r paste0(ifelse(nrow(very_high_pa_by_prov), "* ",""), format_count_summary(very_high_pa_by_prov,"PA","exceeding 100"))`

There was <strong>`r aqhi_p_counts$FEM[3]` FEM monitors</strong> and <strong>`r aqhi_p_counts$PA[3]` PA monitors</strong> in Canada with a mean PM<sub>2.5</sub> concentration for `r format(date_range[2], "%B %Y")` <strong>between 60 and 100 &mu;g m<sup>-3</sup></strong>

`r paste0(ifelse(nrow(high_fem_by_prov), "* ",""),format_count_summary(high_fem_by_prov,"FEM","between 60 and 100"))`

`r paste0(ifelse(nrow(high_pa_by_prov), "* ",""),format_count_summary(high_pa_by_prov,"PA","between 60 and 100"))`

The worst overall day for each province/territory:

`r paste(wd$t, collapse = "\n\n")`
  
</details>

:::
:::

*Select which what timescale to view using the following tabs*

#### Daily

```{r include=TRUE, results = 'asis'}
plot_path |> 
  stringr::str_replace(report_dir_esc,"./") |> 
  plot_card(plot_text, iframe=TRUE, plot_title)
```

#### Monthly

```{r include=TRUE, results = 'asis'}
plot2_path |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot2_text, iframe=TRUE, plot2_title, iframe_height = 625)
```

### <big><strong>Where and when did PM<sub>2.5</sub> events occur?</strong></big> {.tabset}

```{r grids_prov}
# Make data for prov/terr grid plots
grid_data = list(
  median = make_grid_data(obs, median, type = "monthly"),
  maximum = make_grid_data(obs, max, type = "monthly")
)

# Make paths to plot files
plot_paths = report_dir |>
  paste0("plots/prov_median-peak_daily_grid_", 
         monitor_groups |> 
           stringr::str_to_lower() |> 
           stringr::str_replace_all(" ","_"),
         '_', output_date_fmt, ".png") |> 
  setNames(monitor_groups) |> as.list()

# Make and save plots
.tmp = names(monitor_groups) |> lapply(\(m){
  pth = plot_paths[[monitor_groups[names(monitor_groups)==m]]]
  pd = grid_data
  if(m != monitor_groups[3]){
    pd$median = subset(pd$median, monitor == m)
    pd$maximum = subset(pd$max, monitor == m)
  }
  # Make plots
  ggs = lapply(names(pd), \(stat){
    pd[[stat]] |>
      make_grid_plot(xlab = paste("Day of", format(date_range[2], "%B")),
                     stat = stringr::str_to_title(stat), 
                     caption = ifelse(stat == names(pd)[2], plot_captions[[m]], ""))
  })
  # Combine and save plots
  (ggs[[1]] + ggs[[2]]) |> 
    ggsave(filename = pth, height = 4, width = 13, units='in', dpi=300)
}) |> setNames(monitor_groups)

# Define plot summary text (figure titles essentially)
plot_texts = paste0(
  "Median [Left] and maximum [Right] daily PM<sub>2.5</sub> concentrations for all ",names(monitor_groups)," monitoring sites in each province/territory. The median is useful for identifying large scale impacts across the province/territory, while the maximum can be used to identify impacts in at least one area of the province/territory."
)  |> setNames(monitor_groups) |> as.list()

# Make summary data for autmated text for this section
p = grid_data$median |>
  dplyr::group_by(y) |>
  dplyr::summarise(n = sum(as.numeric(fill)>3,na.rm=TRUE)) |>
  subset(n >= 3) |>
  dplyr::arrange(desc(n))
p2 = grid_data$maximum |>
  dplyr::group_by(y) |>
  dplyr::summarise(n = sum(as.numeric(fill)>3,na.rm=TRUE)) |>
  subset(n >= 3) |>
  dplyr::arrange(desc(n))

```

*Select which what scale to view using the following tabs*

#### Province Level {.tabset}

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r join_list_sentence(p$y)` had a significant amount of locations which experienced elevated PM<sub>2.5</sub> concentrations  (> 30 &mu;g m<sup>-3</sup>) for at least 3 days this month [see median plot]. 

`r join_list_sentence(p2$y)` had at least one location which experienced elevated PM<sub>2.5</sub> concentrations (> 30 &mu;g m<sup>-3</sup>) for at least 3 days this month [see maximum plot]. 

</details>

:::
:::

*Select which observation monitors to view using the following tabs*

##### FEM and PA

```{r grids_both, include=TRUE, results = 'asis'}
plot_paths[['FEM and PA']] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[['FEM and PA']])
```

##### FEM Only

```{r grids_fem, include=TRUE, results = 'asis'}
plot_paths[['FEM Only']] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[['FEM Only']])
```

##### PA Only

```{r grids_pa, include=TRUE, results = 'asis'}
plot_paths[['PA Only']] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[['PA Only']])
```

#### Region Level {.tabset}

```{r grids_fcst, include= FALSE}

# Make data for fcst_zone grid plots
grid_data = make_grid_data(obs, median, type = "monthly", fcst_zones)

# Make paths to plot files
plot_paths = paste0(report_dir, "plots/zone_median_daily_grid_", 
                    unlist(prov_order), 
                    '_', output_date_fmt,".png") |> 
  setNames(unlist(prov_order)) |> as.list()

# Make and save plots
plots = lapply(unlist(prov_order), \(p) {
  pth = plot_paths[[p]]
  pd = grid_data |>
    subset(as.character(z) == p) |>
    dplyr::arrange(y) 
  pd |>
    make_grid_plot(xlab = paste("Day of", format(date_range[2], "%B")), 
                   ylab = paste(p,"Forecast Zone"),
                   stat = "Median", 
                   small_text = TRUE,
                   caption = plot_captions$`FEM and PA`) |> 
    ggsave(filename = pth, height = 7, width = 12, units='in', dpi=300)
}) |> setNames(unlist(prov_order))

# Define plot summary text (figure titles essentially)
plot_texts = paste0(
  "Daily median PM<sub>2.5</sub> concentrations for all monitors (FEM and PA) within each forecast zone for ",unlist(prov_order),". A white cell indicates there was no data for that day from any monitor within that zone. Zones are grouped into those with and those without data and are sorted alphabetically."
)  |> setNames(unlist(prov_order)) |> as.list()

# Make summary data for automated text for this section
.tmp = grid_data |>
  subset(y != "Not inside a zone") |>
  dplyr::group_by(z, y) |>
  dplyr::summarise(n = sum(as.numeric(fill) > 3)) |>
  subset(n >= 3) |>
  dplyr::arrange(factor(z,unlist(prov_order)),desc(n))

if(nrow(.tmp)==0){
  text=""
}else{
  text = sapply(unique(.tmp$z), \(p){
    t = .tmp |> subset(z==p)
    paste0("- ",p,": ", t$y |>
      join_list_sentence(oxford=TRUE))
  }) |> paste(collapse = "\n\n")  
}


```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

The following forecast regions experienced elevated PM<sub>2.5</sub> concentrations  (> 30 &mu;g m<sup>-3</sup>) for at least 3 days this month:

`r text`
  
</details>

:::
:::

*Select which province/territory to view using the following tabs*

```{r include = TRUE, results="asis"}

for(p in names(prov_pretty)){
  pp = prov_pretty[[p]]
  cat("##### ",pp,"\n")
  cat(plot_paths[[p]] |> 
        stringr::str_replace(report_dir_esc, "./")|> 
        plot_card(plot_texts[[p]]), "\n")
}

```

### <big><strong>Which sites had the highest concentrations?</strong></big> {.tabset}

```{r site_boxplots}

# Get data for site mean boxplots
pd = obs_summary |>
  dplyr::mutate(monitor2 = ifelse(monitor == "FEM", "FEM Only",
                           ifelse(monitor == "PA","PA Only",
                                  "FEM and PA"))) |>
  dplyr::bind_rows(obs_summary |> dplyr::mutate(monitor2 = "FEM and PA")) |>
  dplyr::mutate(aqhi_p_mean = aqhi_p(pm25_mean)) |>
  dplyr::full_join(expand.grid(prov_terr = unlist(prov_order), 
                        monitor2 = monitor_groups,
                        date_max = unique(obs_summary$date_max))) |>
  dplyr::mutate(date = date_max) |>
  dplyr::mutate(pretty_prov = prov_terr |> 
           factor(names(prov_pretty),prov_pretty))
# Make paths to files for saving plots
plot_paths = paste0(report_dir, "plots/site_mean_boxplots_", 
                    monitor_groups |> 
                      stringr::str_to_lower() |> stringr::str_replace_all(" ","_"), 
                    '_', output_date_fmt,".html") |> 
  setNames(monitor_groups) |> as.list()
# MAke and save plots
.tmp = lapply(monitor_groups, \(m){
  plot = pd |>
    subset(monitor2 == m) |>
    make_site_boxplots(m) |>
    htmlwidgets::saveWidget(plot_paths[[m]],
                            libdir="./libs", 
                            selfcontained = FALSE) 
}) |> setNames(c("FEM Only","PA Only","FEM and PA"))
# Define text for below plots (figure title essentially)
plot_texts = paste0(
  "Each boxplot summarises the distribution of monthly monitoring site (",monitor_groups,") mean PM<sub>2.5</sub> concentrations for that province/territory. Blue points for individual sites are displayed for any monitors higher than that regions 75th percentile. Hover over the blue points (if present) to see details about that specific site; hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province. See the menu in the top right of the plot for more."
) |> as.list() |> setNames(monitor_groups)

# Make summary for automated text
vals = list(
  # Worst FEM site by MAX
  pd |> subset(monitor == "FEM") |>
    dplyr::arrange(desc(pm25_max)) |> head(1) |> dplyr::ungroup() |>
    dplyr::select(M=name,T=monitor, D=nc_dist_km_mean,
           C=nearest_community,P=pretty_prov, PM=pm25_max),
  # Worst FEM site by MEAN
  pd |> subset(monitor == "FEM") |>
    dplyr::arrange(desc(pm25_mean)) |> head(1) |> dplyr::ungroup() |>
    dplyr::select(M=name,T=monitor, D=nc_dist_km_mean,
           C=nearest_community,P=pretty_prov, PM=pm25_mean),
  # Worst PA site by MAX
  pd |> subset(monitor == "PA") |>
    dplyr::arrange(desc(pm25_max)) |> head(1) |> dplyr::ungroup() |>
    dplyr::select(M=name,T=monitor, D=nc_dist_km_mean,
           C=nearest_community,P=pretty_prov, PM=pm25_max),
  # Worst PA site by MEAN
  pd |> subset(monitor == "PA") |>
    dplyr::arrange(desc(pm25_mean)) |> head(1) |> dplyr::ungroup() |>
    dplyr::select(M=name,T=monitor, D=nc_dist_km_mean,
           C=nearest_community,P=pretty_prov, PM=pm25_mean)
  
)

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r vals[[1]]$M` (a `r vals[[1]]$T` monitor located `r vals[[1]]$D` km from `r vals[[1]]$C`) in `r vals[[1]]$P` had the highest observed hourly PM<sub>2.5</sub> concentration in Canada from the FEM network for `r format(date_range[2],"%B %Y")` (`r vals[[1]]$PM` &mu;g m<sup>-3</sup>). During this period, `r vals[[2]]$M` (a `r vals[[2]]$T` monitor located `r vals[[2]]$D` km from `r vals[[2]]$C`) in `r vals[[2]]$P` had the highest 1-month mean in Canada from the FEM network (`r round(vals[[2]]$PM,1)`&mu;g m<sup>-3</sup>).

`r vals[[3]]$M` (a `r vals[[3]]$T` monitor located `r vals[[3]]$D` km from `r vals[[3]]$C`) in `r vals[[3]]$P` had the highest observed hourly PM<sub>2.5</sub> concentration in Canada from the PA network for `r format(date_range[2],"%B %Y")` (`r vals[[3]]$PM` &mu;g m<sup>-3</sup>). During this period, `r vals[[4]]$M` (a `r vals[[4]]$T` monitor located `r vals[[4]]$D` km from `r vals[[4]]$C`) in `r vals[[4]]$P` had the highest 1-month mean in Canada from the PA network (`r round(vals[[4]]$PM,1)`&mu;g m<sup>-3</sup>).
  
</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM and PA"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["FEM and PA"]], iframe=TRUE)
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM Only"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["FEM Only"]], iframe=TRUE)
```

#### PA Only

```{r include=TRUE, results = 'asis'}
plot_paths[["PA Only"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["PA Only"]], iframe=TRUE)
```

### <big><strong>Which communities [with data] had very high PM<sub>2.5</sub>?</strong></big> {.tabset}

```{r community_boxplots}

# Get data for site mean boxplots
pd = obs_summary2 |>
  dplyr::mutate(monitor2 = ifelse(monitor == "FEM", "FEM Only",
                           ifelse(monitor == "PA","PA Only","FEM and PA"))) |>
  dplyr::bind_rows(obs_summary2 |> dplyr::mutate(monitor2 = "FEM and PA") |>
              dplyr::group_by(prov_terr, fcst_zone, 
           nearest_community, monitor2) |>
             dplyr::summarise(n_hours_above_30=max(n_hours_above_30,na.rm=TRUE),
                       n_hours_above_60=max(n_hours_above_60,na.rm=TRUE),
                       n_hours_above_100=max(n_hours_above_100,na.rm=TRUE),
                       pm25_mean=mean(pm25_mean,na.rm=TRUE),
                       pm25_max=max(pm25_max,na.rm=TRUE),
                       n_sites = sum(n_sites,  na.rm=TRUE)
                       )) |>
  dplyr::mutate(aqhi_p_mean = aqhi_p(pm25_mean)) |>
  dplyr::full_join(expand.grid(prov_terr = unlist(prov_order), 
                        monitor2 = monitor_groups,
                        date_max = unique(obs_summary$date_max))) |>
  dplyr::mutate(date = date_max)
# Make paths to files for saving plots
plot_paths = paste0(report_dir, "plots/communities_veryHigh_hours_", 
                    monitor_groups |> stringr::str_to_lower() |> stringr::str_replace_all(" ","_"), 
                    '_', output_date_fmt,".html") |> 
  setNames(monitor_groups) |> as.list()
# MAke and save plots
.tmp = lapply(monitor_groups, \(m){
  pd |>
    subset(monitor2 == m) |>
    make_community_boxplots(m) |>
    htmlwidgets::saveWidget(plot_paths[[m]],
                            libdir="./libs", 
                            selfcontained = FALSE)
}) |> setNames(monitor_groups)
# Define text for below plots (figure title essentially)
plot_texts = paste0(
  "Each boxplot summarises the distribution of 1-month community counts of hours with PM<sub>2.5</sub> concentrations above 100 &mu;g m<sup>-3</sup> for at least one monitoring site (",monitor_groups,") in that community for each province/territory. Blue points for individual communities are displayed for any communities with counts higher than that regions 75th percentile. Hover over the blue points (if present) to see details about that specific community; hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province/territory. See the menu in the top right for more."
) |> as.list() |> setNames(monitor_groups)

# Make summary for automated text
vals = community_summ |>
  dplyr::ungroup() |>
  dplyr::select(P=prov_terr, 
         C = nearest_community,
         N=n_monitors, D = max_dist,
         PM1 = pm25_24hr_mean, PM2 = pm25_24hr_max,
         H1=n_hours_above_100_max,H2=n_hours_above_60_max) |>
    dplyr::mutate(NFEM = N |> stringr::str_extract("FEM: \\d*") |> stringr::str_remove("FEM: ") |>
             handyr::swap(NA, with = "0"),
           NPA = N |> stringr::str_extract("PA: \\d*") |> stringr::str_remove("PA: ") |>
             handyr::swap(NA, with = "0")) 

vals = list(
    vals |>
      dplyr::arrange(desc(PM2)) |>
      head(1) ,
    vals |>
      dplyr::arrange(desc(PM1)) |>
      head(1),
    vals |>
      dplyr::arrange(desc(H1),
              desc(H2)) |>
      head(1)
  )
```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r vals[[1]]$C` (a community in `r vals[[1]]$P` with `r vals[[1]]$NFEM` FEM and `r vals[[1]]$NPA` PA monitors within at least `r vals[[1]]$D` km) had the highest observed hourly PM<sub>2.5</sub> concentration in Canada for `r format(date_range[2], "%B %Y")` (`r vals[[1]]$PM2` &mu;g m<sup>-3</sup>). During this period, `r vals[[2]]$C` (a community in `r vals[[2]]$P` with `r vals[[2]]$NFEM` FEM and `r vals[[2]]$NPA` PA monitors within at least `r vals[[2]]$D` km) had the highest 1-month mean in Canada (`r round(vals[[2]]$PM1,1)` &mu;g m<sup>-3</sup>).

`r vals[[3]]$C` (a community in `r vals[[3]]$P` with `r vals[[3]]$NFEM` FEM and `r vals[[3]]$NPA` PA monitors within at least `r vals[[3]]$D` km)  had `r vals[[3]]$H1` hours where at least one monitor exceeded 100 &mu;g m<sup>-3</sup> and `r vals[[3]]$H2` hours where at least one monitor exceeded 60 &mu;g m<sup>-3</sup>.
  
</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM and PA"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["FEM and PA"]], iframe=TRUE)
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM Only"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["FEM Only"]], iframe=TRUE)
```

#### PA Only

```{r include=TRUE, results = 'asis'}
plot_paths[["PA Only"]] |> 
  stringr::str_replace(report_dir_esc, "./")|> 
  plot_card(plot_texts[["PA Only"]], iframe=TRUE)
```

### <big><strong>What was the worst day this month?</strong></big>{.tabset}

```{r worst_day_tables}
# Make download link and table for province level
dl = worst_day_df |>
  setNames(names(worst_day_df) |> stringr::str_replace_all("\n"," ")) |>
   download_this(
    output_name = "worst_days_by_provterr_" |> 
      paste0(max(obs$date) |> format("%Y-%B")),
    output_extension = ".csv",sep = ",", dec = ".",
    button_label = "Download data as csv",
    button_type = "default",
    has_icon = TRUE,
    csv2 = FALSE,
    icon = "fa fa-save"
  )
table =  reactable(data = worst_day_df,
                   pagination= FALSE,
            defaultSorted = "Mean of Site Means",
            defaultSortOrder = "desc",
            columnGroups = list(
              colGroup(name = "PM2.5 Concentration (ug/m3)", 
                       columns = c("Min of Site Means", 
                                   "Mean of Site Means",
                                   "Max of Site Means")))
    )

# Make download link and table for fcst zone level
pd = obs_daily |>
  dplyr::group_by(nearest_community, date) |>
  dplyr::mutate(n_communities_ge_100 = as.numeric(pm25>=100)) |>
  dplyr::group_by(prov_terr, fcst_zone, date) |>
  dplyr::summarise(
    n_sites = n(),
    n_communities_ge_100 = nearest_community[n_communities_ge_100 == 1] |> 
      unique() |> length(),
    n_sites_above_100 = sum(pm25>=100,na.rm=TRUE),
    mean_pm25 = round(mean(pm25, na.rm=TRUE),1), 
    min_pm25 = min(pm25, na.rm=TRUE), 
    max_pm25 = max(pm25, na.rm=TRUE)
  ) |>
  dplyr::arrange(prov_terr, fcst_zone, desc(n_sites_above_100), 
          desc(n_sites_above_100), desc(mean_pm25)) |>
  dplyr::filter(!duplicated(`fcst_zone`)) |>
  dplyr::rename(worst_day = date) |>
  dplyr::mutate(n_ge_100 = paste0(n_sites_above_100," / ", n_sites, " (",
                           round(n_sites_above_100/n_sites*100,1),"%)"),
         worst_day = format(worst_day,"%B %d (%a)")) |>
  dplyr::select("Prov./Terr." = prov_terr,
         "Forecast Zone" = fcst_zone,
         "Worst Day" = worst_day, 
         "Sites w/ Daily Mean Above 100 ug/m3" = n_ge_100, 
         "Min of Sites" = min_pm25, 
         "Mean of Sites" = mean_pm25,
         "Max of Sites" = max_pm25)
dl2 = pd |>
   download_this(
    output_name = "worst_days_by_fcast_zone_" |> 
      paste0(max(obs$date) |> format("%Y-%B")),
    output_extension = ".csv",sep = ",", dec = ".",
    button_label = "Download data as csv",
    button_type = "default",
    has_icon = TRUE,
    csv2 = FALSE,
    icon = "fa fa-save"
  )
table2 = reactable(data = pd, groupBy = c("Prov./Terr."),
                    defaultSorted = "Mean of Sites",
                    defaultSortOrder = "desc",
                    pagination= FALSE,
                    columnGroups = list(
                      colGroup(name = "Daily Site Mean PM2.5 Concentration (ug/m3)", columns = c("Min of Sites", "Mean of Sites","Max of Sites")))
           )
```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

**STILL IN DEVELOPMENT**
  
</details>

:::
:::

*Select which what scale to view using the following tabs*

#### Province Level

::: card

::: {.card-img-top .p-2}

```{r include = TRUE, cache = FALSE}
dl
table
```

:::

::: card-body

The "worst day" for PM<sub>2.5</sub> concentrations **for each province**. The "worst day" is determined by the day with the most number of observation sites (FEM or PA) having a daily mean exceeding 100 &mu;g m<sup>-3</sup> with ties broken by the highest mean of the site daily mean concentrations across the province/territory.

:::

:::

#### Region Level

::: card

::: {.card-img-top .p-2}

```{r include = TRUE, cache=FALSE}
dl2
table2
```

:::

::: card-body

The "worst day" for PM<sub>2.5</sub> concentrations **for each forecast zone**. Click on the arrow beside a prov./terr. name to expand the table to view the zones for that area. The "worst day" is determined by the day with the most number of observation sites (FEM or PA) having a daily mean exceeding 100 &mu;g m<sup>-3</sup> with ties broken by the highest mean of the site daily mean concentrations across the province/territory.

:::

:::

### <big><strong>Which regions were most impacted, and for which days?</strong></big>

```{r analysis7, cache= FALSE}

dat1 = obs_summary |>
  dplyr::group_by(prov_terr, fcst_zone) |>
  dplyr::summarise(
    pm25_mean_month = mean(pm25_mean, na.rm=TRUE) |>round(1),
    pm25_max_month  = max(pm25_max, na.rm=TRUE),
    n_hours_above_60  = max(n_hours_above_60, na.rm=TRUE),
    n_hours_above_100  = max(n_hours_above_100, na.rm=TRUE),
    n_fem = sum(monitor=="FEM"),
    n_pa = sum(monitor=="PA"),
    n_monitors = n(),
    n_communities_w_data = length(unique(nearest_community)),
    n_communities_w_data_mean_ge_100 = nearest_community[pm25_mean>=100] |> unique() |> length(),
    n_communities_w_data_max_ge_100 = nearest_community[pm25_max>=100] |> unique() |> length(),
    days_w_over_100 = days_w_over_100_max |> 
      stringr::str_split(",", simplify = TRUE) |> 
      as.vector() |> unique() |> 
      as.numeric() |> sort() |>
      shorten_number_list()
  ) |>
  dplyr::left_join(
    fcst_zones |> dplyr::select(fcst_zone, zone_prov = prov_terrs), 
    by = "fcst_zone"
  ) |>
  dplyr::mutate(zone_prov = zone_prov |> stringr::str_replace("YT","YK")) |>
  dplyr::mutate(fcst_zone = iconv(fcst_zone, to = "ASCII//TRANSLIT"),
         n_monitors = paste0(n_monitors, " (",n_fem," FEM, ",n_pa," PA)"),
         n_communities_w_data_mean_ge_100 = paste(
           n_communities_w_data_mean_ge_100, "/",n_communities_w_data),
         n_communities_w_data_max_ge_100 = paste(
           n_communities_w_data_max_ge_100, "/",n_communities_w_data)) |>
  dplyr::arrange(desc(n_hours_above_60)) |>
  dplyr::rename(
    "Prov./Terr." = `zone_prov`, 
    "Forecast Zone" = fcst_zone,
    "# of Monitors" = n_monitors,
    "1-Month Mean (Î¼g/m3)" = pm25_mean_month,
    "1-Month Max (Î¼g/m3)" = pm25_max_month,
    "# of Communities\nw/ Mean > 100 Î¼g/m3" = n_communities_w_data_mean_ge_100,
    "# of Communities\nw/ Max > 100 Î¼g/m3" = n_communities_w_data_max_ge_100,
    "# Hours above 60 Î¼g/m3"= n_hours_above_60,
    "# Hours above 100 Î¼g/m3"= n_hours_above_100,
    "Day(s) of Month w/\n12+ hours Above 100 Î¼g/m3" = days_w_over_100
  ) |>
  as.data.frame()|>
  dplyr::select(14,2,9,3:4,5:6,13)

table =  reactable(
    data=dat1,
    defaultSorted = c("# Hours above 60 Î¼g/m3","# Hours above 100 Î¼g/m3"),
    defaultSortOrder = "desc",
    defaultPageSize = 15#, 
  )
dl = dat1 |>
  setNames(names(dat1) |> stringr::str_replace_all("\n"," ")) |>
  dplyr::mutate("Day(s) of Month w/ 12+ hours Above 100 Î¼g/m3" = paste0("'",`Day(s) of Month w/ 12+ hours Above 100 Î¼g/m3`)) |>
   download_this(
    output_name = "fcst_zone_pm25_summaries_" |> 
      paste0(output_date_fmt),
    output_extension = ".csv",sep = ",",
    button_label = "Download data as csv",
    button_type = "default",
    has_icon = TRUE,
    csv2 = FALSE,
    icon = "fa fa-save"
  )
```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

**STILL IN DEVELOPMENT**
  
</details>

:::
:::

::: card

::: {.card-img-top .p-2}

```{r include = TRUE, cache=FALSE}
dl
table
```

:::

::: card-body

Summary of the PM<sub>2.5</sub> concentration data within each Canadian forecast zone. The table is interactive, filterable, and has multiple pages. The final column here highlights specific days with high smoke impacts.

:::

:::

##
<center><h4 id="footer" style="display:none">----- \*BETA PRODUCT\* -----</h4></center>
