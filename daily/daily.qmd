<meta name="viewport" content="width=device-width, initial-scale=1">

```{js onpageload}
$(window).on('load', () => on_page_load("#analysis-of-past-24-hours-of-pm2\\.5-observations"));  
```

```{r setup}

source("R/report-functions.R")
source("R/report-constants.R")
report_dir <- report_dir |> file.path("daily")
report_dir_esc <- report_dir_esc |> file.path("daily")

date_range <- report_dir |>
  get_report_start_end(type = "daily", run_future = run_current_day)

hours_to_summarise <- date_range |> make_hourly_seq()

plot_timestamp <- date_range[2] |>
  format("%F-%Hz")

plot_captions <- date_range |>
  make_plot_captions(networks = names(monitor_groups))

```

```{r load_data}

obs <- date_range |>
  load_report_data(
    meta_cols = meta_cols,
    cache_path = file.path(report_dir, "index_obs.rds"), # used when db not available
    provinces_n_territories = provinces_n_territories
  )

summaries <- obs |>
  make_summaries(
    type = "daily",
    fcst_zones = fcst_zones,
    meta_cols = meta_cols,
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

max_date <- obs$date |> base::max()
subtitle_date <- list(
  utc = max_date |>
    format("%Y-%m-%d %H UTC"),
  vancouver = max_date |>
    lubridate::with_tz("America/Vancouver") |>
    format("%Y-%m-%d %I %p"),
  halifax = max_date |>
    lubridate::with_tz("America/Halifax") |>
    format("%Y-%m-%d %I %p")
)

```

```{r handleOldReports, include= FALSE, echo= FALSE}

old_report_dropdown <- report_dir |>
  handle_old_reports(
    report_pattern = "[a,b]\\.html$",
    max_date = date_range[2],
    type = "daily"
  )

```

<center><h4>----- \*BETA PRODUCT\* -----</h4></center>
<center><h1>Canadian PM<sub>2.5</sub> Observations 24-hour Summary</h1></center>
<center><h3>Non-validated Data - <mark class="bg-info">`r subtitle_date$utc`</mark></center>
<center><h4>`r subtitle_date$vancouver` in Vancouver --- `r subtitle_date$halifax` in Halifax</h4></center>

|  

## Overview {.unlisted .unnumbered}

<div class="card">
<div class="card-body">

This report is a summary of the **fine particulate matter (PM<sub>2.5</sub>)** observation data in Canada for the **past 24 hours** from the regulatory **Federal Equivalent Method (FEM)** monitors and the network of low-cost monitors from **PurpleAir (PA)**. It is in beta stage and being actively developed. Significant changes may occur without warning. This report is automatically updated at 00 UTC and 12 UTC every day.

`r old_report_dropdown`

For any concerns, questions, or feedback regarding this report or the data within it, please contact brayden.nilson@ec.gc.ca

<details>

<summary>Click here for more details.</summary>
**PM<sub>2.5</sub> is a major constituent of wildfire smoke** and has significant health risks associated with acute and chronic exposure. **FEM monitors are the gold-standard** for real-time data quality for PM<sub>2.5</sub>; however installations are limited by capital and maintenance costs. **PA monitors are less accurate** than their FEM counterparts, but are **much less cost prohibitive** allowing large numbers to be installed. FEM monitors provide **great** data (in **limited areas**), but PA monitors provide **good** data (in **many areas**), and are very useful as "smoke detectors" during wildfire smoke events.

All PM<sub>2.5</sub> data are sourced from the [UNBC AQmap](https://aqmap.ca/aqmap) data repository.

- Data from the FEM network originate from [AirNow](https://www.airnow.gov/about-airnow/), and are NOT VALIDATED. No QA/QC is applied after retrieval from AirNow, and official values may differ from those presented here.

- Data from the PA network originate from the [PurpleAir API](https://api.purpleair.com/), and a rigorous automated QA/QC method is applied to ensure the best available data are used. The [UNBC/ECCC bias correction](https://amt.copernicus.org/articles/15/3315/2022/) is applied to all PA data to improve comparability with FEM values.

</div>
</div>

<div id="loading" style="text-align:center;display: flex; align-items: center; justify-content: center; height: 250px;">
<div>
  <p>Loading, please wait...</p>
  <p><img id="loading-image" src="./icons/loading.gif" alt="Loading..." /></p>
</div>
</div>

## Analysis of Past 24-Hours of PM<sub>2.5</sub> Observations {.tabset .tabset-dropdown style="display:none;"}

*Select your question from the following dropdown menu*

### <big><strong>How many observation sites at each risk level?</strong></big> {.tabset}

```{r prov_donuts}

# Define plot summary text (figure titles essentially)
plot_text_template <- "Distribution of 24-hour mean concentrations at %s PM<sub>2.5</sub> monitoring sites within each province/territory. The number within each circle indicates the total number of monitors with data in that area. Percents indicate the amount of those monitors with a 24-hour mean within that concentration range." |>
  sprintf(monitor_groups)
plot_text = list(
  mean = plot_text_template,
  max = plot_text_template |> stringr::str_replace_all(" mean ", " max ")
) |>
  lapply(\(x) as.list(x) |> setNames(monitor_groups))

# Make summary data for autmated text for this section
p <- c(pa = "PA", fem = "FEM") |>
  lapply(\(network) {
    summaries$donuts$data$mean |>
      dplyr::filter(monitor == network) |>
      dplyr::group_by(monitor, aqhi_p) |>
      dplyr::summarise(n = sum(n), .groups = "drop") |>
      dplyr::mutate(p = round(n / sum(n) * 100, 1))
  })

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

There are <strong>`r sum(p$fem$n)` FEM sites</strong> and <strong>`r sum(p$pa$n)` PA sites</strong> currently reporting PM<sub>2.5</sub> in Canada. <strong>

- `r  p$fem$p[4]`%</strong> of the FEM sites in Canada have a 24-hour mean exceeding 100 &mu;g m<sup>-3</sup>, <strong> `r p$fem$p[3]`%</strong> are between 60 and 100 &mu;g m<sup>-3</sup>, and <strong> `r p$fem$p[2]`%</strong> are between 30 and 60 &mu;g m<sup>-3</sup>.<strong> 

- `r p$pa$p[4]`%</strong> of the PA sites in Canada have a 24-hour mean exceeding 100 &mu;g m<sup>-3</sup>, <strong> `r p$pa$p[3]`%</strong> are between 60 and 100 &mu;g m<sup>-3</sup>, and <strong> `r p$pa$p[2]`%</strong> are between 30 and 60 &mu;g m<sup>-3</sup>.
  
</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_fem_and_pa |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$mean$`FEM and PA`)
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_fem_and_pa |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$max$`FEM and PA`)
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_fem_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$mean$`FEM Only`)
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_fem_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$max$`FEM Only`)
```

#### PA Only

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_pa_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$mean$`PA Only`)
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_pa_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_text$max$`PA Only`)
```

### <big><strong>Where were PM<sub>2.5</sub> concentrations high?</strong></big>{.tabset}

```{r, maps}

map_paths <- summaries$overall |>
  make_and_save_maps(
    monitor_groups = monitor_groups,
    report_dir = report_dir,
    plot_dir = figure_dir,
    lib_dir = lib_dir,
    include_active_fires = FALSE
  )

# Define plot summary text (figure titles essentially)
plot_texts <- "Here is an interactive map showing 24-hour mean PM<sub>2.5</sub> concentrations from monitoring sites (%s) in Canada for the past 24 hours. Canadian forecast zones are shown coloured by the mean 24-hour concentration of the monitors within the zone. Toggle layers displayed in the top right menu.

Below the map is a table summarising the data from the monitoring sites displayed in the map. The table is interactive, filterable, and may have pages if there are many sites. If you click the link on a site's name it will take you to that monitor on [AQmap](https://aqmap.ca/)." |>
  sprintf(monitor_groups) |>
  setNames(monitor_groups) |>
  as.list()

# Make data for tables below maps
table_data <- summaries$overall |>
  make_map_table_data()

# Make tables
map_tables <- lapply(names(monitor_groups), \(monitor_group) {
  table_data |>
    make_map_table(
      monitor_group = monitor_group,
      report_dir = report_dir,
      data_dir = data_dir,
      plot_timestamp = plot_timestamp
    )
}) |>
  setNames(monitor_groups)

# Make summary data for autmated text for this section
very_high_fem_by_prov <- summaries$aqhi_p_counts$by_prov |>
  subset(FEM != 0 & aqhi_p_24hr == "Very High") |>
  dplyr::arrange(desc(FEM))
high_fem_by_prov <- summaries$aqhi_p_counts$by_prov |>
  subset(FEM != 0 & aqhi_p_24hr == "High") |>
  dplyr::arrange(desc(PA))
very_high_pa_by_prov <- summaries$aqhi_p_counts$by_prov |>
  subset(PA != 0 & aqhi_p_24hr == "Very High") |>
  dplyr::arrange(desc(FEM))
high_pa_by_prov <- summaries$aqhi_p_counts$by_prov |>
  subset(PA != 0 & aqhi_p_24hr == "High") |>
  dplyr::arrange(desc(PA))

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

There was <strong>`r summaries$aqhi_p_counts$overall$FEM[4]` FEM monitors</strong> and <strong>`r summaries$aqhi_p_counts$overall$PA[4]` PA monitors</strong> in Canada with a 24-hour mean PM<sub>2.5</sub> concentration <strong>exceeding 100 &mu;g m<sup>-3</sup></strong>

`r paste0(ifelse(nrow(very_high_fem_by_prov), "* ",""), format_count_summary(very_high_fem_by_prov,"FEM","exceeding 100"))`

`r paste0(ifelse(nrow(very_high_pa_by_prov), "* ",""), format_count_summary(very_high_pa_by_prov,"PA","exceeding 100"))`

There was <strong>`r summaries$aqhi_p_counts$overall$FEM[3]` FEM monitors</strong> and <strong>`r summaries$aqhi_p_counts$overall$PA[3]` PA monitors</strong> in Canada with a 24-hour mean PM<sub>2.5</sub> concentration <strong>between 60 and 100 &mu;g m<sup>-3</sup></strong>

`r paste0(ifelse(nrow(high_fem_by_prov), "* ",""),format_count_summary(high_fem_by_prov,"FEM","between 60 and 100"))`

`r paste0(ifelse(nrow(high_pa_by_prov), "* ",""),format_count_summary(high_pa_by_prov,"PA","between 60 and 100"))`

</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
map_paths[["FEM and PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["FEM and PA"]], iframe = TRUE)
```

|

```{r include = TRUE}
map_tables[["FEM and PA"]]$dl_button
map_tables[["FEM and PA"]]$html
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
map_paths[["FEM Only"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["FEM Only"]], iframe = TRUE)
```

|

```{r include = TRUE}
map_tables[["FEM Only"]]$dl_button
map_tables[["FEM Only"]]$html
```

#### PA Only

```{r include=TRUE, results = 'asis'}
map_paths[["PA Only"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["PA Only"]], iframe = TRUE)
```

|

```{r include = TRUE}
map_tables[["PA Only"]]$dl_button
map_tables[["PA Only"]]$html
```


### <big><strong>Which sites had the highest concentrations?</strong></big> {.tabset}

```{r site_boxplots}

boxplots <- summaries$overall |>
  make_and_save_site_boxplots(
    monitor_groups = monitor_groups,
    date_range = date_range,
    date_format = "%Y-%m-%d %H:%M (UTC)",
    avg_text = "24-hour",
    plot_timestamp = plot_timestamp,
    report_dir = report_dir,
    figure_dir = figure_dir,
    lib_dir = lib_dir
  )

plot_paths <- boxplots$paths
vals <- boxplots$summary_values

# Define plot summary text (figure titles essentially)
plot_texts = paste0(
  "Each boxplot summarises the distribution of 24-hour monitoring site (",
  monitor_groups,
  ") mean PM<sub>2.5</sub> concentrations for that province/territory. Blue points for individual sites are displayed for any monitors higher than that regions 75th percentile. Hover over the blue points (if present) to see details about that specific site; hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province. See the menu in the top right of the plot for more."
) |>
  as.list() |>
  setNames(monitor_groups)

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r vals$FEM[[1]]$M` (a `r vals$FEM[[1]]$T` monitor located `r vals$FEM[[1]]$D` km from `r vals$FEM[[1]]$C`) in `r vals$FEM[[1]]$P` had the highest observed hourly PM<sub>2.5</sub> concentration in Canada from the FEM network in the past 24 hours (`r vals$FEM[[1]]$PM` &mu;g m<sup>-3</sup>). During this period, `r vals$FEM[[2]]$M` (a `r vals$FEM[[2]]$T` monitor located `r vals$FEM[[2]]$D` km from `r vals$FEM[[2]]$C`) in `r vals$FEM[[2]]$P` had the highest 24-hour mean in Canada from the FEM network (`r round(vals$FEM[[2]]$PM,1)`&mu;g m<sup>-3</sup>).

`r vals$PA[[1]]$M` (a `r vals$PA[[1]]$T` monitor located `r vals$PA[[1]]$D` km from `r vals$PA[[1]]$C`) in `r vals$PA[[1]]$P` had the highest observed hourly PM<sub>2.5</sub> concentration in Canada from the PA network in the past 24 hours (`r vals$PA[[1]]$PM` &mu;g m<sup>-3</sup>). During this period, `r vals$PA[[2]]$M` (a `r vals$PA[[2]]$T` monitor located `r vals$PA[[2]]$D` km from `r vals$PA[[2]]$C`) in `r vals$PA[[2]]$P` had the highest 24-hour mean in Canada from the PA network (`r round(vals$PA[[2]]$PM,1)`&mu;g m<sup>-3</sup>).
  
</details>

:::
:::

*Select which observation monitors to view using the following tabs*

#### FEM and PA

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM and PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["FEM and PA"]], iframe = TRUE)
```

#### FEM Only

```{r include=TRUE, results = 'asis'}
plot_paths[["FEM"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["FEM Only"]], iframe = TRUE)
```

#### PA Only

```{r include=TRUE, results = 'asis'}
plot_paths[["PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[["PA Only"]], iframe = TRUE)
```

### <big><strong>Where and when did PM<sub>2.5</sub> events occur?</strong></big> {.tabset}

```{r grids_prov}

# Make data for prov/terr grid plots
grid_data <- list(median = median, maximum = max) |>
  lapply(\(FUN) obs |> make_grid_data(FUN = FUN, type = "daily"))

# Make paths to plot files
plot_paths <- grid_data |>
  make_and_save_prov_terr_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    monitor_groups = monitor_groups,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_captions = plot_captions
  )

# Define plot summary text (figure titles essentially)
plot_texts <- paste(
  "Median and maximum hourly PM<sub>2.5</sub> concentrations",
  "for all %s monitoring sites in each province/territory.",
  "The median is useful for identifying large scale impacts across the province/territory,",
  "while the maximum can be used to identify impacts in at least one area of the province/territory."
) |>
  sprintf(names(monitor_groups)) |>
  setNames(monitor_groups) |>
  as.list()

# Make summary data for autmated text for this section
p <- grid_data |>
  lapply(\(dat) {
    dat |>
      dplyr::group_by(y) |>
      dplyr::summarise(n = sum(as.numeric(fill) > 3, na.rm = TRUE)) |>
      subset(n >= 3) |>
      dplyr::arrange(desc(n))
  })

```

*Select which what scale to view using the following tabs*

#### Province Level {.tabset}

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r join_list_sentence(p$median$y)` had a significant amount of locations which experienced elevated PM<sub>2.5</sub> concentrations  (> 30 &mu;g m<sup>-3</sup>) for at least 3 of the past 24 hours [see median plot]. 

`r join_list_sentence(p$maximum$y)` had at least one location which experienced elevated PM<sub>2.5</sub> concentrations (> 30 &mu;g m<sup>-3</sup>) for at least 3 of the past 24 hours [see maximum plot]. 

</details>

:::
:::

*Select which observation monitors to view using the following tabs*

##### FEM and PA

```{r grids_both, include=TRUE, results = 'asis'}
plot_paths[['FEM and PA']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[['FEM and PA']])
```

##### FEM Only

```{r grids_fem, include=TRUE, results = 'asis'}
plot_paths[['FEM']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[['FEM Only']])
```

##### PA Only

```{r grids_pa, include=TRUE, results = 'asis'}
plot_paths[['PA']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(plot_texts[['PA Only']])
```

#### Region Level {.tabset}

```{r grids_fcst, include= FALSE}

# Make data and save fcst_zone grid plots
fcst_grid_data <- obs |>
  dplyr::mutate(monitor = "FEM and PA") |>
  make_grid_data(FUN = median, type = "daily", fcst_zones = fcst_zones)

plot_paths <- fcst_grid_data |>
  make_and_save_fcst_zone_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_caption = plot_captions$`FEM and PA`,
    provinces_n_territories = provinces_n_territories
  )

# Define plot summary text (figure titles essentially)
plot_texts <- paste(
  "Hourly median PM<sub>2.5</sub> concentrations for all monitors (FEM and PA) within each forecast zone for %s.",
  "A white cell indicates there was no data for that hour from any monitor within that zone.",
  "Zones are grouped into those with and those without data and are sorted alphabetically."
) |>
  sprintf(provinces_n_territories) |>
  setNames(provinces_n_territories) |>
  as.list()

# Make summary data for automated text for this section
text <- fcst_grid_data |>
  make_grid_summary_text()

```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

The following forecast regions experienced elevated PM<sub>2.5</sub> concentrations  (> 30 &mu;g m<sup>-3</sup>) for at least 3 of the past 24 hours:

`r text`
  
</details>

:::
:::

*Select which province/territory to view using the following tabs*

```{r, include = TRUE, results="asis"}

for (pt_name in names(provinces_n_territories)) {
  pt_abbr <- provinces_n_territories[[pt_name]]
  cat("##### ", pt_abbr, "\n")
  cat(
    plot_paths[[pt_abbr]] |>
      stringr::str_replace(report_dir_esc, "./") |>
      plot_card(plot_texts[[pt_abbr]]),
    "\n"
  )
}

```

### <big><strong>Which communities (with data) were impacted?</strong></big>

```{r community_summary, include = TRUE}

# Make data for table
table_data = summaries$community |>
  dplyr::arrange(desc(pm25_24hr_mean)) |>
  dplyr::mutate(aqmap_link = make_aqmap_link(nc_lat, nc_lng, 12, "EN")) |>
  dplyr::mutate(fcst_zone = iconv(fcst_zone, to = "ASCII//TRANSLIT")) |>
  dplyr::ungroup() |>
  dplyr::select(
    "Name" = nearest_community,
    "Prov./Terr." = prov_terr,
    "Forecast Zone" = fcst_zone,
    "# of Monitors" = n_monitors,
    "Max Distance (km)" = max_dist,
    "24hr Mean (μg/m3)" = pm25_24hr_mean,
    "24hr Max (μg/m3)" = pm25_24hr_max,
    "Current (μg/m3)" = pm25_current_mean,
    # "# Hours\nabove 30 μg/m3"= n_hours_above_30_max,
    "# Hours\nabove 60 μg/m3" = n_hours_above_60_max,
    "# Hours\nabove 100 μg/m3" = n_hours_above_100_max,
    aqmap_link
  ) |>
  as.data.frame() |>
  # dplyr::select(3,1:2,4,5,7:13,15,16) |>
  subset(!duplicated(Name))

# Make table
table = reactable(
  data = table_data |>
    dplyr::arrange(desc("24hr Mean (μg/m3)")),
  #groupBy = c("Prov./Terr."),
  defaultSorted = c("# Hours\nabove 100 μg/m3", "24hr Mean (μg/m3)"),
  defaultSortOrder = "desc",

  columns = list(
    'Name' = colDef(cell = \(com) {
      url = table_data[table_data$Name == com, "aqmap_link"]
      htmltools::tags$a(href = url, target = "_blank", com)
    }),
    aqmap_link = colDef(show = FALSE)
  ),
  columnGroups = list(
    colGroup(
      name = "Community Details",
      columns = c("Name", "Prov./Terr.", "Forecast Zone")
    ),
    colGroup(
      name = "PM2.5 Monitors",
      columns = c("# of Monitors", "Max Distance (km)")
    ),
    colGroup(
      name = "PM2.5 Observations",
      columns = c(
        "24hr Mean (μg/m3)",
        "24hr Max (μg/m3)",
        "Current (μg/m3)", #"# Hours\nabove 30 μg/m3",
        "# Hours\nabove 60 μg/m3",
        "# Hours\nabove 100 μg/m3"
      )
    )
  )
)

# Write out data to CSV
file = "high_pm2.5_communities_" |>
  paste0(
    max(obs$date) |>
      format("%Y-%m-%d_%HZ")
  ) |>
  paste0(".csv")
table_data = table_data |>
  dplyr::select(-aqmap_link)
table_data |>
  setNames(names(table_data) |> stringr::str_replace_all("\n", " ")) |>
  data.table::fwrite(
    paste0(paste0(report_dir, "data/"), file),
    dateTimeAs = "write.csv"
  )

# Make download button linked to this csv
dl = dl_button_html("./data/", file)

# Make summary data for automated text for this section
pd = summaries$community |>
  dplyr::ungroup() |>
  dplyr::select(
    P = prov_terr,
    C = nearest_community,
    N = n_monitors,
    D = max_dist,
    PM1 = pm25_24hr_mean,
    PM2 = pm25_24hr_max,
    H1 = n_hours_above_100_max,
    H2 = n_hours_above_60_max
  ) |>
  dplyr::mutate(
    NFEM = N |>
      stringr::str_extract("FEM: \\d*") |>
      stringr::str_remove("FEM: ") |>
      handyr::swap(NA, with = "0"),
    NPA = N |>
      stringr::str_extract("PA: \\d*") |>
      stringr::str_remove("PA: ") |>
      handyr::swap(NA, with = "0")
  )
vals = list(
  pd |>
    dplyr::arrange(desc(PM2)) |>
    head(1),
  pd |>
    dplyr::arrange(desc(PM1)) |>
    head(1),
  pd |>
    dplyr::arrange(desc(H1), desc(H2)) |>
    head(1)
)
```

::: card
::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r vals[[1]]$C` (a community in `r vals[[1]]$P` with `r vals[[1]]$NFEM` FEM and `r vals[[1]]$NPA` PA monitors within at least `r vals[[1]]$D` km) had the highest observed hourly PM<sub>2.5</sub> concentration in Canada in the past 24 hours (`r vals[[1]]$PM2` &mu;g m<sup>-3</sup>). During this period, `r vals[[2]]$C` (a community in `r vals[[2]]$P` with `r vals[[2]]$NFEM` FEM and `r vals[[2]]$NPA` PA monitors within at least `r vals[[2]]$D` km) had the highest 24-hour mean in Canada (`r round(vals[[2]]$PM1,1)` &mu;g m<sup>-3</sup>).

`r vals[[3]]$C` (a community in `r vals[[3]]$P` with `r vals[[3]]$NFEM` FEM and `r vals[[3]]$NPA` PA monitors within at least `r vals[[3]]$D` km)  had `r vals[[3]]$H1` hours where at least one monitor exceeded 100 &mu;g m<sup>-3</sup> and `r vals[[3]]$H2` hours where at least one monitor exceeded 60 &mu;g m<sup>-3</sup>.
  
</details>

:::
:::

::: card

::: {.card-img-top .p-2}

```{r include=TRUE}

dl
table

```


:::

::: card-body

Canadian communities with at least 1 nearby PM<sub>2.5</sub> monitor reporting PM<sub>2.5</sub> concentrations in the past 24 hours. The table is interactive, filterable, and has multiple pages. If you click the link on a community name it will take you to that community on [AQmap](https://aqmap.ca/).

:::

:::


##
<center><h4 id="footer" style="display:none">----- \*BETA PRODUCT\* -----</h4></center>