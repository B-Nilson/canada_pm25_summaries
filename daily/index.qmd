---
params:
  report: !expr source("../R/set_params.R"); set_params(type = "daily")
title: "Canadian PM<sub>2.5</sub> Observations Daily Summary for <mark class='bg-info'>`r params$report$display_name`</mark>"
subtitle: | 
  Non-validated, auto-QA/QCed data representing `r params$report$date_ranges$utc`<br>
  `r params$report$date_ranges$vancouver` in Vancouver |
  `r params$report$date_ranges$halifax` in Halifax
date: "`r params$report$date`"
citation: 
  id: daily-report
  title: "Daily Canada PM2.5 Summary: {RNAME}"
  url: https://aqmap.ca/aqmap/reports/daily/historic/{RFILE}.html
  publisher: "University of Northern British Columbia, Environment and Climate Change Canada"

format:
  html:
    pagetitle: "Daily Canada PM2.5 Summary"
---

<meta name="viewport" content="width=device-width, initial-scale=1">

```{r setup}

source("R/report-functions.R")
source("R/report-constants.R")
report_dir <- report_dir |> file.path("daily")

date_range <- report_dir |>
  get_report_start_end(
    type = "daily",
    run_future = run_current_day,
    default_date = .default_report_date
  )

old_report_dropdown <- report_dir |>
  handle_old_reports(report_pattern = "[day,night]\\.html$")

```

```{r load_data}

obs <- date_range |>
  load_report_data(
    meta_cols = meta_cols,
    cache_path = file.path(report_dir, "index_obs.rds"), # used when db not available
    provinces_n_territories = provinces_n_territories
  )

# Alter dange range if needed (only when cached data is used)
date_range <- range(obs$date)
hours_to_summarise <- date_range |> make_hourly_seq() # TODO: pass as arg where used
plot_timestamp <- date_range[2] |>
  format("%F-%Hz")
plot_captions <- date_range |>
  make_plot_captions(networks = names(monitor_groups))
fig_caption_date_range <- date_range |>
  lubridate::with_tz("UTC") |>
  format("%b %d, %Y %H:%M UTC") |>
  paste(collapse = " to ")

summaries <- obs |>
  make_summaries(
    type = "daily",
    fcst_zones = fcst_zones,
    meta_cols = meta_cols,
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

max_date <- obs$date |> base::max()

```

```{r fig_titles}

plot_text_template <- "Monitor counts and frequencies of median AQHI risk levels for %s {{< var terms.pm25 >}} concentrations for monitoring sites within each province/territory for %s. The number within each circle indicates the total monitors with data in that area during the report period. Percentages indicate the proportion of those monitors with a median AQHI risk at that level for this report." |>
  sprintf(names(monitor_groups), fig_caption_date_range) |> 
  stringr::str_replace_all(" PA ", " {{< var terms.PA >}} ") |>
  stringr::str_replace_all(" FEM ", " {{< var terms.FEM >}} ")
prov_donuts_text <- list(
  median = plot_text_template,
  max = plot_text_template |> stringr::str_replace_all(" median ", " max ")
) |>
  lapply(\(x) as.list(x) |> setNames(monitor_groups))

map_text <- "Interactive map of 24-hour mean {{< var terms.pm25 >}} concentrations
from {{< var terms.FEM >}} and {{< var terms.PA >}} monitoring sites (shown as diamons and cirles, repsectively) within Canada for %s. 
Canadian forecast zones are shown coloured by the mean of the 24-hour mean concentrations from all monitors within the zone.
Hover over a monitor or click on a forecast zone for additional details.
Layers can be controlled in the top right menu." |>
  sprintf(fig_caption_date_range)

overall_table_caption <- "Canadian {{< var terms.FEM >}} and {{< var terms.PA >}} monitor {{< var terms.pm25 >}} observation summary for %s. 
The table is sortable, filterable, and has multiple pages.
Click the link on a monitor name to view that monitor's location on [AQmap](https://aqmap.ca/)." |>
  sprintf(fig_caption_date_range)

boxplot_texts <- "Distributions of site-mean {{< var terms.pm25 >}} concentrations for %s monitors in each province/territory from %s.
Blue points show any sites with a mean concentration higher than that region's 75th percentile, with additional details displayed when hovered over. Hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province. 
See the menu in the top right of the plot for more." |>
  sprintf(names(monitor_groups), fig_caption_date_range) |>
  stringr::str_replace_all(" PA ", " {{< var terms.PA >}} ") |>
  stringr::str_replace_all(" FEM ", " {{< var terms.FEM >}} ") |>
  as.list() |>
  setNames(monitor_groups)

prov_grid_texts <- paste(
  "Median and maximum hourly {{< var terms.pm25 >}} concentrations",
  "for all %s monitoring sites in each province/territory from %s.",
  "The median is useful for identifying large scale impacts across the province/territory,",
  "while the maximum can be used to identify impacts in at least one area."
) |>
  sprintf(names(monitor_groups), fig_caption_date_range) |>
  stringr::str_replace_all(" PA ", " {{< var terms.PA >}} ") |>
  stringr::str_replace_all(" FEM ", " {{< var terms.FEM >}} ") |>
  setNames(monitor_groups) |>
  as.list()

fcst_grid_texts <- paste(
  "Hourly median {{< var terms.pm25 >}} concentrations for all {{< var terms.FEM >}} and {{< var terms.PA >}} monitors within each %s forecast zone for %s.",
  "A white cell indicates there was no data for that hour from any monitor within that zone.",
  "Zones are grouped into those with and those without monitors and are sorted alphabetically."
) |>
  sprintf(provinces_n_territories, fig_caption_date_range) |>
  setNames(provinces_n_territories) |>
  as.list()

community_table_caption <- "Canadian communities with at least one nearby {{< var terms.FEM >}} or {{< var terms.PA >}} {{< var terms.pm25 >}} monitor with data from %s. 
The table is sortable, filterable, and has multiple pages.
Click on a name to view that community on [AQmap](https://aqmap.ca/)." |>
  sprintf(fig_caption_date_range)

```


```{r prov_donuts}

# plots created and saved in make_summaries()
# Make summary data for automated text for this section
# TODO: move to build_prov_donut_summary()
prov_donuts_text$p <- c(pa = "PA", fem = "FEM") |>
  lapply(\(network) {
    summaries$donuts$data |>
      lapply(\(stat_data) {
        stat_data |>
          dplyr::filter(monitor == network) |>
          dplyr::group_by(monitor, aqhi_p) |>
          dplyr::summarise(n = sum(n), .groups = "drop") |>
          dplyr::mutate(p = round(n / sum(n) * 100, 1))
      })
  })

```

```{r, maps}

map_path <- summaries$overall |>
  make_and_save_overall_map(
    zone_summary = summaries$by_zone,
    monitor_group = "FEM and PA",
    report_dir = report_dir,
    plot_dir = figure_dir,
    lib_dir = lib_dir,
    include_active_fires = FALSE,
    map_timestamps = date_range
  )

map_card <- map_path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = map_text,
    iframe = TRUE,
    iframe_height = 617,
    plot_timestamp = plot_timestamp
  )

# Make and save tables
overall_summary_table <- summaries$overall |>
  make_overall_summary_table(
    report_dir = report_dir,
    monitor_group = "FEM and PA",
    data_dir = data_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

overall_summary_table$card <- overall_summary_table$path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = overall_table_caption,
    iframe = TRUE,
    is_table = TRUE,
    iframe_height = 590,
    plot_timestamp = plot_timestamp
  ) |>
  stringr::str_replace(
    "</iframe>",
    paste0("</iframe>\n", overall_summary_table$dl_button)
  ) |>
  knitr::asis_output()

```

```{r site_boxplots}

boxplots <- summaries$overall |>
  make_and_save_site_boxplots(
    monitor_groups = monitor_groups,
    date_range = date_range,
    date_format = "%Y-%m-%d %H:%M (UTC)",
    avg_text = "24-hour",
    plot_timestamp = plot_timestamp,
    report_dir = report_dir,
    figure_dir = figure_dir,
    lib_dir = lib_dir
  )

```

```{r grids_prov}

# Make data for prov/terr grid plots
grid_data <- list(median = median, maximum = max) |>
  lapply(\(FUN) obs |> make_grid_data(FUN = FUN, type = "daily"))

# Make paths to plot files
prov_grid_paths <- grid_data |>
  make_and_save_prov_terr_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    monitor_groups = monitor_groups,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_captions = plot_captions
  )

```

```{r grids_fcst, include= FALSE}

# Make data and save fcst_zone grid plots
fcst_grid_data <- obs |>
  dplyr::mutate(monitor = "FEM and PA") |>
  make_grid_data(FUN = median, type = "daily", fcst_zones = fcst_zones)

fcst_grid_paths <- fcst_grid_data |>
  make_and_save_fcst_zone_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_caption = plot_captions$`FEM and PA`,
    provinces_n_territories = provinces_n_territories
  )

```


```{r community_summary, include = TRUE}

community_table <- summaries$community |>
  make_community_table(
    report_dir = report_dir,
    data_dir = data_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

community_table$card <- community_table$path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = community_table_caption,
    iframe = TRUE,
    is_table = TRUE,
    iframe_height = 590,
    plot_timestamp = plot_timestamp
  ) |>
  stringr::str_replace(
    "</iframe>",
    paste0("</iframe>\n", community_table$dl_button)
  ) |>
  knitr::asis_output()

```

<!-- Report Start -->

## Overview {.unlisted .unnumbered}

`r build_overview_card(type = "daily", report_dropdown = old_report_dropdown)`

## Past 24-Hours of PM<sub>2.5</sub> Observations

`r build_prov_donut_summary(prov_donuts_text, type = "daily")`

:::: panel-tabset

`r tab_explainers$summary_tabs`

## Mean PM<sub>2.5</sub>

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, summaries$donuts$paths$median, prov_donuts_text$median, report_dir, plot_timestamp = plot_timestamp)`

## Max PM<sub>2.5</sub>

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, summaries$donuts$paths$max, prov_donuts_text$max, report_dir, plot_timestamp = plot_timestamp)`

::::

### Where were PM<sub>2.5</sub> concentrations high?

`r build_map_summary(summaries$aqhi_p_counts, type = "daily")`

`r overall_summary_table$card`

`r map_card`

`r build_community_summary(summaries$community, type = "daily")`

`r community_table$card`

### When did PM<sub>2.5</sub> events occur?

`r build_prov_grid_summary(grid_data, type = "daily")`

`r build_fcst_grid_summary(fcst_grid_data, type = "daily")`

`r tab_explainers$scale_tabs`

:::: panel-tabset

## Province Level

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, prov_grid_paths, prov_grid_texts, report_dir, plot_timestamp = plot_timestamp)`

## Region Level 

`r tab_explainers$prov_terr_tabs`

`r build_tabs(provinces_n_territories, fcst_grid_paths, fcst_grid_texts, report_dir, plot_timestamp = plot_timestamp)`

::::

### Where were the worst PM<sub>2.5</sub> concentrations?

`r build_boxplot_summary(boxplots$summary_values, type = "daily")`  

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, boxplot$paths, boxplot_texts, report_dir, iframe = TRUE, iframe_height = 526, plot_timestamp = plot_timestamp)`
