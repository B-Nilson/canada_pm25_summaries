---
format:
  html:
    pagetitle: "24hr Canada PM<sub>2.5</sub> Summary"
    include-in-header: 
      - text: |
          <script src="https://code.jquery.com/jquery-4.0.0.min.js"></script>
          <script>
            var main_header = "#analysis-of-past-24-hours-of-pm2\\.5-observations";
            var icons = [
                "icons8-doughnut-chart-64.png",
                "icons8-map-64.png",
                "icons8-vertical-timeline-64.png",
                "icons8-data-sheet-64.png",
                "icons8-grid-64.png"
            ].map((f_name) => "index_files/icons/" + f_name);
            $(document).ready(() => on_page_load(main_header, icons));
          </script>
---

<meta name="viewport" content="width=device-width, initial-scale=1">

```{r setup}

source("R/report-functions.R")
source("R/report-constants.R")
report_dir <- report_dir |> file.path("daily")
report_dir_esc <- report_dir_esc |> file.path("daily")

date_range <- report_dir |>
  get_report_start_end(type = "daily", run_future = run_current_day)

hours_to_summarise <- date_range |> make_hourly_seq()

plot_timestamp <- date_range[2] |>
  format("%F-%Hz")

plot_captions <- date_range |>
  make_plot_captions(networks = names(monitor_groups))

```

```{r load_data}

obs <- date_range |>
  load_report_data(
    meta_cols = meta_cols,
    cache_path = file.path(report_dir, "index_obs.rds"), # used when db not available
    provinces_n_territories = provinces_n_territories
  )

summaries <- obs |>
  make_summaries(
    type = "daily",
    fcst_zones = fcst_zones,
    meta_cols = meta_cols,
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

max_date <- obs$date |> base::max()

```

```{r prov_donuts}

# plots created and saved in make_summaries()

# Define plot summary text (figure titles essentially)
plot_text_template <- "Distribution of 24-hour mean concentrations at %s PM<sub>2.5</sub> monitoring sites within each province/territory. The number within each circle indicates the total number of monitors with data in that area. Percents indicate the amount of those monitors with a 24-hour mean within that concentration range." |>
  sprintf(monitor_groups)
prov_donuts_text <- list(
  mean = plot_text_template,
  max = plot_text_template |> stringr::str_replace_all(" mean ", " max ")
) |>
  lapply(\(x) as.list(x) |> setNames(monitor_groups))

# Make summary data for autmated text for this section
prov_donuts_text$p <- c(pa = "PA", fem = "FEM") |>
  lapply(\(network) {
    summaries$donuts$data$mean |>
      dplyr::filter(monitor == network) |>
      dplyr::group_by(monitor, aqhi_p) |>
      dplyr::summarise(n = sum(n), .groups = "drop") |>
      dplyr::mutate(p = round(n / sum(n) * 100, 1))
  })

```

```{r, maps}

map_paths <- summaries$overall |>
  make_and_save_maps(
    monitor_groups = monitor_groups,
    report_dir = report_dir,
    plot_dir = figure_dir,
    lib_dir = lib_dir,
    include_active_fires = FALSE
  )

# Define plot summary text (figure titles essentially)
map_texts <- "Here is an interactive map showing 24-hour mean PM<sub>2.5</sub> concentrations from monitoring sites (%s) in Canada for the past 24 hours. Canadian forecast zones are shown coloured by the mean 24-hour concentration of the monitors within the zone. Toggle layers displayed in the top right menu.

Below the map is a table summarising the data from the monitoring sites displayed in the map. The table is interactive, filterable, and may have pages if there are many sites. If you click the link on a site's name it will take you to that monitor on [AQmap](https://aqmap.ca/)." |>
  sprintf(monitor_groups) |>
  setNames(monitor_groups) |>
  as.list()

# Make data for tables below maps
table_data <- summaries$overall |>
  make_map_table_data()

# Make tables
map_tables <- lapply(names(monitor_groups), \(monitor_group) {
  table_data |>
    make_map_table(
      monitor_group = monitor_group,
      report_dir = report_dir,
      data_dir = data_dir,
      plot_timestamp = plot_timestamp
    )
}) |>
  setNames(monitor_groups)

```

```{r site_boxplots}

boxplots <- summaries$overall |>
  make_and_save_site_boxplots(
    monitor_groups = monitor_groups,
    date_range = date_range,
    date_format = "%Y-%m-%d %H:%M (UTC)",
    avg_text = "24-hour",
    plot_timestamp = plot_timestamp,
    report_dir = report_dir,
    figure_dir = figure_dir,
    lib_dir = lib_dir
  )

boxplot_paths <- boxplots$paths

# Define plot summary text (figure titles essentially)
boxplot_texts = paste0(
  "Each boxplot summarises the distribution of 24-hour monitoring site (",
  monitor_groups,
  ") mean PM<sub>2.5</sub> concentrations for that province/territory. Blue points for individual sites are displayed for any monitors higher than that regions 75th percentile. Hover over the blue points (if present) to see details about that specific site; hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province. See the menu in the top right of the plot for more."
) |>
  as.list() |>
  setNames(monitor_groups)

```

```{r grids_prov}

# Make data for prov/terr grid plots
grid_data <- list(median = median, maximum = max) |>
  lapply(\(FUN) obs |> make_grid_data(FUN = FUN, type = "daily"))

# Make paths to plot files
prov_grid_paths <- grid_data |>
  make_and_save_prov_terr_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    monitor_groups = monitor_groups,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_captions = plot_captions
  )

# Define plot summary text (figure titles essentially)
prov_grid_texts <- paste(
  "Median and maximum hourly PM<sub>2.5</sub> concentrations",
  "for all %s monitoring sites in each province/territory.",
  "The median is useful for identifying large scale impacts across the province/territory,",
  "while the maximum can be used to identify impacts in at least one area of the province/territory."
) |>
  sprintf(names(monitor_groups)) |>
  setNames(monitor_groups) |>
  as.list()

```

```{r grids_fcst, include= FALSE}

# Make data and save fcst_zone grid plots
fcst_grid_data <- obs |>
  dplyr::mutate(monitor = "FEM and PA") |>
  make_grid_data(FUN = median, type = "daily", fcst_zones = fcst_zones)

fcst_grid_paths <- fcst_grid_data |>
  make_and_save_fcst_zone_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_caption = plot_captions$`FEM and PA`,
    provinces_n_territories = provinces_n_territories
  )

# Define plot summary text (figure titles essentially)
fcst_grid_texts <- paste(
  "Hourly median PM<sub>2.5</sub> concentrations for all monitors (FEM and PA) within each forecast zone for %s.",
  "A white cell indicates there was no data for that hour from any monitor within that zone.",
  "Zones are grouped into those with and those without data and are sorted alphabetically."
) |>
  sprintf(provinces_n_territories) |>
  setNames(provinces_n_territories) |>
  as.list()

# Make summary data for automated text for this section
fcst_grid_texts$text <- fcst_grid_data |>
  make_grid_summary_text()

```


```{r community_summary, include = TRUE}

# Make data for table
table_data <- summaries$community |>
  dplyr::arrange(desc(pm25_mean_network_mean_comm_mean)) |>
  dplyr::mutate(
    aqmap_link = nc_lat |>
      make_aqmap_link(lng = nc_lng, zoom = 12, lang = "EN")
  ) |>
  dplyr::select(
    "Name" = nearest_community,
    "Prov./Terr." = prov_terr,
    "Forecast Zone" = fcst_zone,
    "# of Monitors" = n_monitors,
    "Max Distance (km)" = nc_dist_km_network_max_comm_max,
    "24hr Mean (μg/m3)" = pm25_mean_network_mean_comm_mean,
    "24hr Max (μg/m3)" = pm25_max_network_max_comm_max,
    "Current (μg/m3)" = pm25_current_network_mean_comm_mean,
    # "# Hours\nabove 30 μg/m3"= n_hours_above_30_max,
    "# Hours\nabove 60 μg/m3" = n_hours_above_60_network_max_comm_max,
    "# Hours\nabove 100 μg/m3" = n_hours_above_100_network_max_comm_max,
    aqmap_link
  )

# Make table
columns <- list(
  'Name' = reactable::colDef(cell = \(com) {
    url = table_data[table_data$Name == com, "aqmap_link"]
    htmltools::tags$a(href = url, target = "_blank", com)
  }),
  aqmap_link = reactable::colDef(show = FALSE)
)
col_groups <- list(
  reactable::colGroup(
    name = "Community Details",
    columns = c("Name", "Prov./Terr.", "Forecast Zone")
  ),
  reactable::colGroup(
    name = "PM2.5 Monitors",
    columns = c("# of Monitors", "Max Distance (km)")
  ),
  reactable::colGroup(
    name = "PM2.5 Observations",
    columns = c(
      "24hr Mean (μg/m3)",
      "24hr Max (μg/m3)",
      "Current (μg/m3)", #"# Hours\nabove 30 μg/m3",
      "# Hours\nabove 60 μg/m3",
      "# Hours\nabove 100 μg/m3"
    )
  )
)

community_table <- table_data |>
  dplyr::arrange(desc("24hr Mean (μg/m3)")) |>
  reactable(
    data = _,
    defaultSorted = c("# Hours\nabove 100 μg/m3", "24hr Mean (μg/m3)"),
    defaultSortOrder = "desc",
    columns = columns,
    columnGroups = col_groups
  )

# Write out data to CSV and make download button linked to it
file_path <- "%s/%s/community_summary_%s.csv" |>
  sprintf(report_dir, data_dir, plot_timestamp)
community_table_dl <- table_data |>
  make_download_button(data_dir = data_dir, file_path = file_path)

# Make summary data for automated text for this section
pd <- summaries$community |>
  dplyr::select(
    P = prov_terr,
    C = nearest_community,
    N = n_monitors,
    D = nc_dist_km_network_max_comm_max,
    PM1 = pm25_mean_network_mean_comm_mean,
    PM2 = pm25_max_network_max_comm_max,
    H1 = n_hours_above_100_network_max_comm_max,
    H2 = n_hours_above_60_network_max_comm_max
  ) |>
  dplyr::mutate(
    NFEM = N |>
      stringr::str_extract("FEM: \\d*") |>
      stringr::str_remove("FEM: ") |>
      handyr::swap(NA, with = "0"),
    NPA = N |>
      stringr::str_extract("PA: \\d*") |>
      stringr::str_remove("PA: ") |>
      handyr::swap(NA, with = "0")
  )
community_table_vals <- list(
  pd |>
    dplyr::arrange(desc(PM2)) |>
    head(1),
  pd |>
    dplyr::arrange(desc(PM1)) |>
    head(1),
  pd |>
    dplyr::arrange(desc(H1), desc(H2)) |>
    head(1)
)
```

```{r handleOldReports, include= FALSE, echo= FALSE}

old_report_dropdown <- report_dir |>
  handle_old_reports(
    report_pattern = "[a,b]\\.html$",
    max_date = date_range[2],
    type = "daily"
  )

```

<!-- Report Start -->

`r build_header(type = "daily", date_range = date_range)`

## Overview {.unlisted .unnumbered}

`r build_overview_card(type = "daily", report_dropdown = old_report_dropdown, contact_email = contact_email)`

## Analysis of Past 24-Hours of PM<sub>2.5</sub> Observations

`r tab_explainers$primary_tabs`

::: {.panel-tabset .primary-tabset}

## <big><strong>How many observation sites at each risk level?</strong></big>

`r build_prov_donut_summary(prov_donuts_text, type = "daily")`

`r tab_explainers$network_tabs`

:::: panel-tabset

## FEM and PA

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_fem_and_pa |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$mean$`FEM and PA`) |>
  cat()
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_fem_and_pa |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$max$`FEM and PA`) |>
  cat()
```

## FEM Only

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_fem_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$mean$`FEM Only`) |>
  cat()
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_fem_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$max$`FEM Only`) |>
  cat()
```

## PA Only

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$mean_pa_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$mean$`PA Only`) |>
  cat()
```

```{r include=TRUE, results = 'asis'}
summaries$donuts$paths$max_pa_only |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_donuts_text$max$`PA Only`) |>
  cat()
```

::::

## <big><strong>Where were PM<sub>2.5</sub> concentrations high?</strong></big>

`r build_map_summary(summaries$aqhi_p_counts, type = "daily")`

`r tab_explainers$network_tabs`

:::: panel-tabset

## FEM and PA

```{r include=TRUE, results = 'asis'}
map_paths[["FEM and PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(map_texts[["FEM and PA"]], iframe = TRUE) |>
  cat()
```

|

```{r include = TRUE}
map_tables[["FEM and PA"]]$dl_button
map_tables[["FEM and PA"]]$html
```

## FEM Only

```{r include=TRUE, results = 'asis'}
map_paths[["FEM Only"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(map_texts[["FEM Only"]], iframe = TRUE) |>
  cat()
```

|

```{r include = TRUE}
map_tables[["FEM Only"]]$dl_button
map_tables[["FEM Only"]]$html
```

## PA Only

```{r include=TRUE, results = 'asis'}
map_paths[["PA Only"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(map_texts[["PA Only"]], iframe = TRUE) |>
  cat()
```

|

```{r include = TRUE}
map_tables[["PA Only"]]$dl_button
map_tables[["PA Only"]]$html
```

::::

## <big><strong>Which sites had the highest concentrations?</strong></big>

`r build_boxplot_summary(boxplots$summary_values, type = "daily")`  

`r tab_explainers$network_tabs`

:::: panel-tabset

## FEM and PA

```{r include=TRUE, results = 'asis'}
boxplot_paths[["FEM and PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(boxplot_texts[["FEM and PA"]], iframe = TRUE) |>
  cat()
```

## FEM Only

```{r include=TRUE, results = 'asis'}
boxplot_paths[["FEM"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(boxplot_texts[["FEM Only"]], iframe = TRUE) |>
  cat()
```

## PA Only

```{r include=TRUE, results = 'asis'}
boxplot_paths[["PA"]] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(boxplot_texts[["PA Only"]], iframe = TRUE) |>
  cat()
```

::::

## <big><strong>Where and when did PM<sub>2.5</sub> events occur?</strong></big>

`r tab_explainers$scale_tabs`

:::: panel-tabset

## Province Level

`r build_prov_grid_summary(grid_data, type = "daily")`

`r tab_explainers$network_tabs`

::::: panel-tabset

## FEM and PA

```{r grids_both, include=TRUE, results = 'asis'}
prov_grid_paths[['FEM and PA']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_grid_texts[['FEM and PA']]) |>
  cat()
```

## FEM Only

```{r grids_fem, include=TRUE, results = 'asis'}
prov_grid_paths[['FEM']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_grid_texts[['FEM Only']]) |>
  cat()
```

## PA Only

```{r grids_pa, include=TRUE, results = 'asis'}
prov_grid_paths[['PA']] |>
  stringr::str_replace(report_dir_esc, "./") |>
  plot_card(prov_grid_texts[['PA Only']]) |>
  cat()
```

:::::

## Region Level 

::::: card

:::::: card-body

<details>
<summary>Click for an automated text summary.</summary>

The following forecast regions experienced elevated PM<sub>2.5</sub> concentrations  (> 30 {{< pm_units >}}) for at least 3 of the past 24 hours:

`r fcst_grid_texts$text`
  
</details>

::::::

:::::

`r tab_explainers$prov_terr_tabs`

```{r, include = TRUE, results="asis"}

chunks <- provinces_n_territories |>
  sapply(\(pt_abbr) {
    card <- fcst_grid_paths[[pt_abbr]] |>
      stringr::str_replace(report_dir_esc, "./") |>
      plot_card(fcst_grid_texts[[pt_abbr]])
    "## %s\n%s" |>
      sprintf(pt_abbr, card)
  })

":::::::: panel-tabset
%s
::::::::" |>
  sprintf(paste(chunks, collapse = "\n")) |>
  cat()

```

::::

## <big><strong>Which communities (with data) were impacted?</strong></big>

:::: card

::::: card-body

<details>
<summary>Click for an automated text summary.</summary>

`r community_table_vals[[1]]$C` (a community in `r community_table_vals[[1]]$P`
with `r community_table_vals[[1]]$NFEM` FEM and `r community_table_vals[[1]]$NPA` PA monitors
within at least `r community_table_vals[[1]]$D` km) had the highest observed hourly PM<sub>2.5</sub> concentration
in Canada in the past 24 hours (`r community_table_vals[[1]]$PM2` {{< pm_units >}}). 
During this period, `r community_table_vals[[2]]$C` (a community in `r community_table_vals[[2]]$P` 
with `r community_table_vals[[2]]$NFEM` FEM and `r community_table_vals[[2]]$NPA` PA monitors
within at least `r community_table_vals[[2]]$D` km) had the highest 24-hour mean in Canada
(`r round(community_table_vals[[2]]$PM1,1)` {{< pm_units >}}).

`r community_table_vals[[3]]$C` (a community in `r community_table_vals[[3]]$P`
with `r community_table_vals[[3]]$NFEM` FEM and `r community_table_vals[[3]]$NPA` PA monitors
within at least `r community_table_vals[[3]]$D` km)  had `r community_table_vals[[3]]$H1` hours
where at least one monitor exceeded 100 {{< pm_units >}} and `r community_table_vals[[3]]$H2` hours
where at least one monitor exceeded 60 {{< pm_units >}}.
  
</details>

:::::

::::

:::: card

::::: {.card-img-top .p-2}

```{r include=TRUE}

community_table_dl
community_table

```

:::::

::::: card-body

Canadian communities with at least 1 nearby PM<sub>2.5</sub> monitor reporting PM<sub>2.5</sub> concentrations in the past 24 hours. The table is interactive, filterable, and has multiple pages. If you click the link on a community name it will take you to that community on [AQmap](https://aqmap.ca/).

:::::

::::

:::

##
