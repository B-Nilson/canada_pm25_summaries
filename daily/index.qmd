---
params:
  report: !expr source("../R/set_params.R"); set_params(type = "daily")
title: "Canadian PM<sub>2.5</sub> Observations Daily Summary for <mark class='bg-info'>`r params$report$name_parsed`</mark>"
subtitle: | 
  Non-validated, auto-QA/QCed data representing `r params$report$date_ranges$utc`<br>
  `r params$report$date_ranges$vancouver` in Vancouver |
  `r params$report$date_ranges$halifax` in Halifax
date: "`r params$report$date`"
citation: 
  id: daily-report
  title: "24hr Canada PM2.5 Summary"
  url: https://aqmap.ca/aqmap/reports/daily
  publisher: "University of Northern British Columbia, Environment and Climate Change Canada"

format:
  html:
    pagetitle: "24hr Canada PM2.5 Summary"
---

<meta name="viewport" content="width=device-width, initial-scale=1">

```{r setup}

source("R/report-functions.R")
source("R/report-constants.R")
report_dir <- report_dir |> file.path("daily")

date_range <- report_dir |>
  get_report_start_end(type = "daily", run_future = run_current_day)

```

```{r load_data}

obs <- date_range |>
  load_report_data(
    meta_cols = meta_cols,
    cache_path = file.path(report_dir, "index_obs.rds"), # used when db not available
    provinces_n_territories = provinces_n_territories
  )

# Alter dange range if needed (only when cached data is used)
date_range <- range(obs$date)
hours_to_summarise <- date_range |> make_hourly_seq() # TODO: pass as arg where used
plot_timestamp <- date_range[2] |>
  format("%F-%Hz")
plot_captions <- date_range |>
  make_plot_captions(networks = names(monitor_groups))

summaries <- obs |>
  make_summaries(
    type = "daily",
    fcst_zones = fcst_zones,
    meta_cols = meta_cols,
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

max_date <- obs$date |> base::max()

```

```{r prov_donuts}

# plots created and saved in make_summaries()

# Define plot summary text (figure titles essentially)
plot_text_template <- "Distribution of 24-hour mean concentrations at %s PM<sub>2.5</sub> monitoring sites within each province/territory. The number within each circle indicates the total number of monitors with data in that area. Percents indicate the amount of those monitors with a 24-hour mean within that concentration range." |>
  sprintf(monitor_groups)
prov_donuts_text <- list(
  mean = plot_text_template,
  max = plot_text_template |> stringr::str_replace_all(" mean ", " max ")
) |>
  lapply(\(x) as.list(x) |> setNames(monitor_groups))

# Make summary data for autmated text for this section
prov_donuts_text$p <- c(pa = "PA", fem = "FEM") |>
  lapply(\(network) {
    summaries$donuts$data$mean |>
      dplyr::filter(monitor == network) |>
      dplyr::group_by(monitor, aqhi_p) |>
      dplyr::summarise(n = sum(n), .groups = "drop") |>
      dplyr::mutate(p = round(n / sum(n) * 100, 1))
  })

```

```{r, maps}

map_path <- summaries$overall |>
  make_and_save_overall_map(
    zone_summary = summaries$by_zone,
    monitor_group = "FEM and PA",
    report_dir = report_dir,
    plot_dir = figure_dir,
    lib_dir = lib_dir,
    include_active_fires = FALSE
  )
# Define plot summary text (figure titles essentially)
map_text <- "Here is an interactive map showing 24-hour mean PM<sub>2.5</sub> concentrations from FEM and PA monitoring sites in Canada for the past 24 hours. 
Canadian forecast zones are shown coloured by the mean 24-hour concentration of the monitors within the zone. Toggle layers displayed in the top right menu."

map_card <- map_path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = map_text,
    iframe = TRUE,
    iframe_height = 617
  )

# Make and save tables
overall_summary_table <- summaries$overall |>
  make_overall_summary_table(
    report_dir = report_dir,
    monitor_group = "FEM and PA",
    data_dir = data_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

table_caption <- "Canadian PM<sub>2.5</sub> monitor observation summaries. 
The table is interactive, filterable, and has multiple pages.
If you click the link on a monitor name it will take you to that monitor's location on [AQmap](https://aqmap.ca/)."

overall_summary_table$card <-  overall_summary_table$path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = table_caption,
    iframe = TRUE,
    is_table = TRUE,
    iframe_height = 526
  ) |>
  stringr::str_replace(
    "</iframe>",
    paste0("</iframe>\n", overall_summary_table$dl_button)
  ) |>
  knitr::asis_output()

```

```{r site_boxplots}

boxplots <- summaries$overall |>
  make_and_save_site_boxplots(
    monitor_groups = monitor_groups,
    date_range = date_range,
    date_format = "%Y-%m-%d %H:%M (UTC)",
    avg_text = "24-hour",
    plot_timestamp = plot_timestamp,
    report_dir = report_dir,
    figure_dir = figure_dir,
    lib_dir = lib_dir
  )

boxplot_paths <- boxplots$paths

# Define plot summary text (figure titles essentially)
boxplot_texts = paste0(
  "Each boxplot summarises the distribution of 24-hour monitoring site (",
  monitor_groups,
  ") mean PM<sub>2.5</sub> concentrations for that province/territory. Blue points for individual sites are displayed for any monitors higher than that regions 75th percentile. Hover over the blue points (if present) to see details about that specific site; hover over the boxplot (away from the points) to see the min/median/max and 25th/75th percentiles for that province. See the menu in the top right of the plot for more."
) |>
  as.list() |>
  setNames(monitor_groups)

```

```{r grids_prov}

# Make data for prov/terr grid plots
grid_data <- list(median = median, maximum = max) |>
  lapply(\(FUN) obs |> make_grid_data(FUN = FUN, type = "daily"))

# Make paths to plot files
prov_grid_paths <- grid_data |>
  make_and_save_prov_terr_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    monitor_groups = monitor_groups,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_captions = plot_captions
  )

# Define plot summary text (figure titles essentially)
prov_grid_texts <- paste(
  "Median and maximum hourly PM<sub>2.5</sub> concentrations",
  "for all %s monitoring sites in each province/territory.",
  "The median is useful for identifying large scale impacts across the province/territory,",
  "while the maximum can be used to identify impacts in at least one area of the province/territory."
) |>
  sprintf(names(monitor_groups)) |>
  setNames(monitor_groups) |>
  as.list()

```

```{r grids_fcst, include= FALSE}

# Make data and save fcst_zone grid plots
fcst_grid_data <- obs |>
  dplyr::mutate(monitor = "FEM and PA") |>
  make_grid_data(FUN = median, type = "daily", fcst_zones = fcst_zones)

fcst_grid_paths <- fcst_grid_data |>
  make_and_save_fcst_zone_grids(
    report_dir = report_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp,
    xlab = "Hour of Day",
    plot_caption = plot_captions$`FEM and PA`,
    provinces_n_territories = provinces_n_territories
  )

# Define plot summary text (figure titles essentially)
fcst_grid_texts <- paste(
  "Hourly median PM<sub>2.5</sub> concentrations for all monitors (FEM and PA) within each forecast zone for %s.",
  "A white cell indicates there was no data for that hour from any monitor within that zone.",
  "Zones are grouped into those with and those without data and are sorted alphabetically."
) |>
  sprintf(provinces_n_territories) |>
  setNames(provinces_n_territories) |>
  as.list()

```


```{r community_summary, include = TRUE}

community_table <- summaries$community |>
  make_community_table(
    report_dir = report_dir,
    data_dir = data_dir,
    figure_dir = figure_dir,
    plot_timestamp = plot_timestamp
  )

table_caption <- "Canadian communities with at least 1 nearby PM<sub>2.5</sub> monitor
reporting PM<sub>2.5</sub> concentrations in the past 24 hours. 
The table is interactive, filterable, and has multiple pages.
If you click the link on a community name it will take you to that community on [AQmap](https://aqmap.ca/)."
community_table$card <- community_table$path |>
  stringr::str_replace(stringr::fixed(report_dir), "./") |>
  plot_card(
    text = table_caption,
    iframe = TRUE,
    is_table = TRUE,
    iframe_height = 526
  ) |>
  stringr::str_replace(
    "</iframe>",
    paste0("</iframe>\n", community_table$dl_button)
  ) |>
  knitr::asis_output()

```

```{r handleOldReports, include= FALSE, echo= FALSE}

old_report_dropdown <- report_dir |>
  handle_old_reports(
    report_pattern = "[a,b]\\.html$",
    max_date = date_range[2],
    type = "daily"
  )

```

<!-- Report Start -->

## Overview {.unlisted .unnumbered}

`r build_overview_card(type = "daily", report_dropdown = old_report_dropdown)`

### Analysis of Past 24-Hours of PM<sub>2.5</sub> Observations

`r build_prov_donut_summary(prov_donuts_text, type = "daily")`

:::: panel-tabset

`r tab_explainers$summary_tabs`

## Mean PM<sub>2.5</sub>

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, summaries$donuts$paths$mean, prov_donuts_text$mean, report_dir)`

## Max PM<sub>2.5</sub>

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, summaries$donuts$paths$max, prov_donuts_text$max, report_dir)`

::::

### Where were PM<sub>2.5</sub> concentrations high?

`r build_map_summary(summaries$aqhi_p_counts, type = "daily")`

`r overall_summary_table$card`

`r map_card`

### Where and when did PM<sub>2.5</sub> events occur?

`r tab_explainers$scale_tabs`

:::: panel-tabset

## Province Level

`r build_prov_grid_summary(grid_data, type = "daily")`

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, prov_grid_paths, prov_grid_texts, report_dir)`

## Region Level 

`r build_fcst_grid_summary(fcst_grid_data, type = "daily")`

`r tab_explainers$prov_terr_tabs`

`r build_tabs(provinces_n_territories, fcst_grid_paths, fcst_grid_texts, report_dir)`

::::

### Which sites had the highest concentrations?

`r build_boxplot_summary(boxplots$summary_values, type = "daily")`  

`r tab_explainers$network_tabs`

`r build_tabs(monitor_groups, boxplot_paths, boxplot_texts, report_dir, iframe = TRUE, iframe_height = 526)`

### Which communities (with data) were impacted?

`r build_community_summary(summaries$community, type = "daily")`

`r community_table$card`
